/*!
 * flipnote.js v2.2.0
 * Browser-based playback of .ppm and .kwz animations from Flipnote Studio and Flipnote Studio 3D
 * 2018 James Daniel
 * github.com/jaames/flipnote.js
 * Flipnote Studio is (c) Nintendo Co., Ltd.
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.flipnote=t():e.flipnote=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var i=t[a]={i:a,l:!1,exports:{}};return e[a].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(a,i,function(t){return e[t]}.bind(null,i));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=6)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}();var i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.buffer=t,this._data=new DataView(t),this._offset=0}return a(e,[{key:"seek",value:function(e,t){switch(t){case 2:this._offset=this._data.byteLength+e;break;case 1:this._offset+=e;break;case 0:default:this._offset=e}}},{key:"readUint8",value:function(){var e=this._data.getUint8(this._offset);return this._offset+=1,e}},{key:"writeUint8",value:function(e){this._data.setUint8(this._offset,e),this._offset+=1}},{key:"readInt8",value:function(){var e=this._data.getInt8(this._offset);return this._offset+=1,e}},{key:"writeInt8",value:function(e){this._data.setInt8(this._offset,e),this._offset+=1}},{key:"readUint16",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this._data.getUint16(this._offset,e);return this._offset+=2,t}},{key:"writeUint16",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._data.setUint16(this._offset,e,t),this._offset+=2}},{key:"readInt16",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this._data.getInt16(this._offset,e);return this._offset+=2,t}},{key:"writeInt16",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._data.setInt16(this._offset,e,t),this._offset+=2}},{key:"readUint32",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this._data.getUint32(this._offset,e);return this._offset+=4,t}},{key:"writeUint32",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._data.setUint32(this._offset,e,t),this._offset+=4}},{key:"readInt32",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this._data.getInt32(this._offset,e);return this._offset+=4,t}},{key:"writeInt32",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._data.setInt32(this._offset,e,t),this._offset+=4}},{key:"readHex",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=new Uint8Array(this._data.buffer,this._offset,e);this._offset+=r.byteLength;for(var a=[],i=0;i<r.length;i++)a.push(r[i].toString(16).padStart(2,"0"));return t&&a.reverse(),a.join("").toUpperCase()}},{key:"readUtf8",value:function(e){var t=new Uint8Array(this._data.buffer,this._offset,e);this._offset+=t.byteLength;for(var r="",a=0;a<t.length;a++){var i=t[a];if(0==i)break;r+=String.fromCharCode(i)}return r}},{key:"writeUtf8",value:function(e){for(var t=0;t<e.length;t++){var r=e.charCodeAt(t);this.writeUint8(r)}}},{key:"readUtf16",value:function(e){var t=new Uint16Array(this._data.buffer,this._offset,e);this._offset+=t.byteLength;for(var r="",a=0;a<t.length;a++){var i=t[a];if(0==i)break;r+=String.fromCharCode(i)}return r}},{key:"byteLength",get:function(){return this._data.byteLength}}]),e}();t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),i=s(r(9)),n=s(r(10));function s(e){return e&&e.__esModule?e:{default:e}}var o=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:640,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:480,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{antialias:!1,alpha:!1};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.width=t.width=r,this.height=t.height=a;var o=t.getContext("webgl",s),u=o.createProgram();this.program=u,this.el=t,this.gl=o,this.refs={shaders:[],textures:[],buffers:[]};var f=this._createShader(o.VERTEX_SHADER,i.default),h=this._createShader(o.FRAGMENT_SHADER,n.default);if(o.attachShader(u,f),o.attachShader(u,h),o.linkProgram(u),!o.getProgramParameter(u,o.LINK_STATUS)){var l=o.getProgramInfoLog(u);throw o.deleteProgram(u),new Error(l)}o.useProgram(u);var d=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,d),o.bufferData(o.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),o.STATIC_DRAW),o.enableVertexAttribArray(0),o.vertexAttribPointer(0,2,o.FLOAT,!1,0,0),this.refs.buffers.push(d),o.activeTexture(o.TEXTURE0);var c=o.createTexture();o.bindTexture(o.TEXTURE_2D,c),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),this.uniforms={};for(var v=o.getProgramParameter(u,o.ACTIVE_UNIFORMS),_=0;_<v;_++){var y=o.getActiveUniform(u,_).name;this.uniforms[y]=o.getUniformLocation(u,y)}o.uniform1i(this.uniforms.u_bitmap,0),this.setFilter("linear"),this.setMode("PPM"),this.refs.textures.push(c),o.enable(o.BLEND),o.blendFunc(o.ONE,o.ONE_MINUS_SRC_ALPHA)}return a(e,[{key:"_createShader",value:function(e,t){var r=this.gl,a=r.createShader(e);if(r.shaderSource(a,t),r.compileShader(a),!r.getShaderParameter(a,r.COMPILE_STATUS)){var i=r.getShaderInfoLog(a);throw r.deleteShader(a),new Error(i)}return this.refs.shaders.push(a),a}},{key:"toImage",value:function(e,t){return this.el.toDataURL(e,t)}},{key:"setFilter",value:function(e){var t=this.gl;e="linear"==e?t.LINEAR:t.NEAREST,t.uniform1i(this.uniforms.u_isSmooth,"linear"==e?0:1),t.activeTexture(t.TEXTURE0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e)}},{key:"setMode",value:function(e){var t=this.gl;"PPM"===e?this.textureType=t.ALPHA:"KWZ"===e&&(this.textureType=t.LUMINANCE_ALPHA)}},{key:"setColor",value:function(e,t){this.gl.uniform4f(this.uniforms[e],t[0]/255,t[1]/255,t[2]/255,1)}},{key:"setPaperColor",value:function(e){this.gl.clearColor(e[0]/255,e[1]/255,e[2]/255,1)}},{key:"drawLayer",value:function(e,t,r,a,i,n){var s=this.gl;s.activeTexture(s.TEXTURE0),s.texImage2D(s.TEXTURE_2D,0,this.textureType,t,r,0,this.textureType,s.UNSIGNED_BYTE,e),this.setColor("u_color1",a),this.setColor("u_color2",i),s.drawArrays(s.TRIANGLES,0,6)}},{key:"resize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:640,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:480;this.el.width=e,this.el.height=t,this.width=e,this.height=t,this.gl.viewport(0,0,e,t)}},{key:"clear",value:function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}},{key:"destroy",value:function(){var e=this.refs,t=this.gl;e.shaders.forEach(function(e){t.deleteShader(e)}),e.shaders=[],e.textures.forEach(function(e){t.deleteTexture(e)}),e.textures=[],e.buffers.forEach(function(e){t.deleteBuffer(e)}),e.buffers=[],t.deleteProgram(this.program),t.canvas.width=1,t.canvas.height=1}}]),e}();t.default=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=new DataView(e,0,4).getUint32(0);if(1346458177==t)return new a.default(e);if(1262897152==(4294967040&t))return new i.default(e)};var a=n(r(3)),i=n(r(5));function n(e){return e&&e.__esModule?e:{default:e}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),i=function(e){return e&&e.__esModule?e:{default:e}}(r(0)),n=r(4);var s={1:.5,2:1,3:2,4:4,5:6,6:12,7:20,8:30},o=256,u=192,f=[14,14,14],h=[255,255,255],l=[10,57,255],d=[255,42,42],c=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r.type="PPM",r.seek(4),r._frameDataLength=r.readUint32(),r._soundDataLength=r.readUint32(),r.frameCount=r.readUint16()+1,r.seek(18),r.thumbFrameIndex=r.readUint16(),r.seek(1696);var a=r.readUint16();return r.seek(1704),r._frameOffsets=new Uint32Array(a/4).map(function(e){return 1704+a+r.readUint32()}),r._decodeSoundHeader(),r.meta=r._decodeMeta(),r._layers=[new Uint8Array(o*u),new Uint8Array(o*u)],r._prevLayers=[new Uint8Array(o*u),new Uint8Array(o*u)],r._prevFrameIndex=0,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.default),a(t,[{key:"readFilename",value:function(){return[this.readHex(3),this.readUtf8(13),this.readUint16().toString().padStart(3,"0")].join("_")}},{key:"readLineEncoding",value:function(){for(var e=new Uint8Array(u),t=0;t<48;t++)for(var r=this.readUint8(),a=0;a<8;a+=2)e[4*t+a/2]=r>>a&3;return e}},{key:"_decodeMeta",value:function(){this.seek(16);var e=this.readUint16(),t=this.readInt16(),r=this.readUtf16(11),a=this.readUtf16(11),i=this.readUtf16(11),n=this.readHex(8,!0),s=this.readHex(8,!0),o=this.readFilename(),u=this.readFilename(),f=this.readHex(8,!0);this.seek(154);var h=new Date(1e3*(this.readUint32()+946684800));return this.seek(1702),{lock:e,loop:this.readUint16()>>1&1,frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:t,timestamp:h,spinoff:s!==n||s!==f,root:{filename:null,username:r,fsid:f},parent:{username:a,fsid:n,filename:o},current:{username:i,fsid:s,filename:u}}}},{key:"_decodeSoundHeader",value:function(){var e=1696+this._frameDataLength+this.frameCount;e%4!=0&&(e+=4-e%4),this.seek(e);var t=this.readUint32(),r=this.readUint32(),a=this.readUint32(),i=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),e+=32,this.framerate=s[this.frameSpeed],this.bgmrate=s[this.bgmSpeed],this.soundMeta={bgm:{offset:e,length:t},se1:{offset:e+=t,length:r},se2:{offset:e+=r,length:a},se3:{offset:e+=a,length:i}}}},{key:"isNewFrame",value:function(e){return this.seek(this._frameOffsets[e]),this.readUint8()>>7&1}},{key:"getFramePalette",value:function(e){this.seek(this._frameOffsets[e]);var t=this.readUint8(),r=1&t,a=[null,1==r?f:h,d,l];return[1==r?h:f,a[t>>1&3],a[t>>3&3]]}},{key:"decodeFrame",value:function(e){0===e||this._prevFrameIndex===e-1||this.isNewFrame(e)||this.decodeFrame(e-1),this.seek(this._frameOffsets[e]);var t=this.readUint8(),r=t>>7&1,a=t>>5&3,i=0,n=0;this._prevLayers[0].set(this._layers[0]),this._prevLayers[1].set(this._layers[1]),this._prevFrameIndex=e,this._layers[0].fill(0),this._layers[1].fill(0),a&&(i=this.readInt8(),n=this.readInt8());for(var s=[this.readLineEncoding(),this.readLineEncoding()],f=0;f<2;f++)for(var h=this._layers[f],l=0;l<u;l++){var d=l*o,c=s[f][l];switch(c){case 0:break;case 1:case 2:var v=this.readUint32(!1);for(2==c&&h.fill(255,d,d+o);4294967295&v;){if(2147483648&v)for(var _=this.readUint8(),y=0;y<8;y++)h[d+y]=_>>y&1?255:0;d+=8,v<<=1}break;case 3:for(;d<(l+1)*o;){for(_=this.readUint8(),y=0;y<8;y++)h[d+y]=_>>y&1?255:0;d+=8}}}if(!r)for(var m,p,b=0;b<u;b++)for(var g=0;g<o;g++)p=(m=g+b*o)-(i+n*o),g-i>o||g-i<0||(this._layers[0][m]^=this._prevLayers[0][p],this._layers[1][m]^=this._prevLayers[1][p]);return this._layers}},{key:"hasAudioTrack",value:function(e){var t=["bgm","se1","se2","se3"][e];return this.soundMeta[t].length>0}},{key:"decodeAudio",value:function(e){for(var t,r,a,i=this.soundMeta[e],s=new Uint8Array(this.buffer,i.offset,i.length),o=new Int16Array(2*s.length),u=0,f=0,h=0,l=0;l<s.length;l++)for(var d=s[l],c=0;c<8;)t=d>>c&15,r=f+n.ADPCM_SAMPLE_TABLE_4[t+16*h],a=h+n.ADPCM_INDEX_TABLE_4[t],a=Math.max(0,Math.min(a,79)),r=Math.max(-32767,Math.min(r,32767)),o[u]=r,u+=1,h=a,f=r,c+=4;return o}},{key:"decodeSoundFlags",value:function(){var e=this;return this.seek(1696+this._frameDataLength),new Array(this.frameCount).fill([]).map(function(t){var r=e.readUint8();return[1&r,r>>1&1,r>>2&1]})}}],[{key:"validateFSID",value:function(e){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(e)}},{key:"validateFilename",value:function(e){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(e)}}]),t}();t.default=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ADPCM_INDEX_TABLE_2=new Int8Array([-1,2,-1,2]),t.ADPCM_INDEX_TABLE_4=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]);for(var a=t.ADPCM_STEP_TABLE=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),i=t.ADPCM_SAMPLE_TABLE_2=new Int16Array(360),n=0;n<4;n++)for(var s=0;s<90;s++){var o=a[s],u=o>>3;1&n&&(u+=o),2&n&&(u=-u),i[n+4*s]=u}for(var f=t.ADPCM_SAMPLE_TABLE_4=new Int16Array(1440),h=0;h<16;h++)for(var l=0;l<90;l++){var d=a[l],c=d>>3;4&h&&(c+=d),2&h&&(c+=d>>1),1&h&&(c+=d>>2),8&h&&(c=-c),f[h+16*l]=c}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),i=function(e){return e&&e.__esModule?e:{default:e}}(r(0)),n=r(4);var s=[.2,.5,1,2,4,6,8,12,20,24,30],o=[[255,255,255],[16,16,16],[255,16,16],[255,231,0],[0,134,49],[0,56,206],[255,255,255]],u=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r.type="KWZ",r._table1=new Uint16Array([0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740]),r._table2=new Uint16Array([0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100]),r._table3=new Uint16Array(6561);for(var a=[0,3,7,1,4,8,2,5,6],i=0,n=0;n<9;n++)for(var s=0;s<9;s++)for(var o=0;o<9;o++)for(var u=0;u<9;u++)r._table3[i]=9*(9*(9*a[n]+a[s])+a[o])+a[u],i++;r._linetable=new Uint16Array(52488);a=[0,65280,255];for(var f=0,h=0;h<3;h++)for(var l=0;l<3;l++)for(var d=0;d<3;d++)for(var c=0;c<3;c++)for(var v=0;v<3;v++)for(var _=0;_<3;_++)for(var y=0;y<3;y++)for(var m=0;m<3;m++)r._linetable.set([a[l],a[h],a[c],a[d],a[_],a[v],a[m],a[y]],f),f+=8;return r._layers=[new Uint16Array(76800),new Uint16Array(76800),new Uint16Array(76800)],r._bitIndex=0,r._bitValue=0,r.load(),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.default),a(t,[{key:"load",value:function(){this.seek(0),this.sections={};for(var e=this.byteLength-256,t=0,r=0;t<e&&r<6;){this.seek(t);var a=this.readUtf8(4).substring(0,3),i=this.readUint32();this.sections[a]={offset:t,length:i},t+=i+8,r+=1}this._decodeMeta(),this._decodeSoundHeader(),this.frameMeta=[],this.frameOffsets=[],this.seek(this.sections.KMI.offset+8),t=this.sections.KMC.offset+12;for(var n=0;n<this.frameCount;n++){var s={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readUtf8(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(s),this.frameOffsets.push(t),t+=s.layerSize[0]+s.layerSize[1]+s.layerSize[2]}this._prevDecodedFrame=-1}},{key:"readBits",value:function(e){if(this._bitIndex+e>16){var t=this.readUint16();this._bitValue|=t<<16-this._bitIndex,this._bitIndex-=16}var r=(1<<e)-1,a=this._bitValue&r;return this._bitValue>>=e,this._bitIndex+=e,a}},{key:"_decodeMeta",value:function(){this.seek(this.sections.KFH.offset+12);var e=new Date(1e3*(this.readUint32()+946684800)),t=new Date(1e3*(this.readUint32()+946684800)),r=(this.readUint32(),this.readHex(10)),a=this.readHex(10),i=this.readHex(10),n=this.readUtf16(11),o=this.readUtf16(11),u=this.readUtf16(11),f=this.readUtf8(28),h=this.readUtf8(28),l=this.readUtf8(28),d=this.readUint16(),c=this.readUint16(),v=this.readUint16(),_=this.readUint8();this.readUint8();this.frameCount=d,this.thumbFrameIndex=c,this.frameSpeed=_,this.framerate=s[_],this.meta={lock:1&v,loop:v>>1&1,frame_count:d,frame_speed:_,thumb_index:c,timestamp:t,creation_timestamp:e,root:{username:n,fsid:r,filename:f},parent:{username:o,fsid:a,filename:h},current:{username:u,fsid:i,filename:l}}}},{key:"_decodeSoundHeader",value:function(){var e=this.sections.KSN.offset+8;this.seek(e);var t=this.readUint32();this.bgmSpeed=t,this.bgmrate=s[t];var r=new Uint32Array(this.buffer,e+4,20);this.soundMeta={bgm:{offset:e+=28,length:r[0]},se1:{offset:e+=r[0],length:r[1]},se2:{offset:e+=r[1],length:r[2]},se3:{offset:e+=r[2],length:r[3]},se4:{offset:e+=r[3],length:r[4]}}}},{key:"getDiffingFlag",value:function(e){return 7&~(this.frameMeta[e].flags>>4)}},{key:"getLayerDepths",value:function(e){return this.frameMeta[e].layerDepth}},{key:"decodeFrame",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];r&&(t&=this.getDiffingFlag(e+1)),0!==e&&this._prevDecodedFrame!==e-1&&t&&this.decodeFrame(e-1,t=t,r=!0);for(var a=this.frameMeta[e],i=this.frameOffsets[e],n=0;n<3;n++){this.seek(i);var s=a.layerSize[n];if(i+=s,38!==s&&!(t>>n&!1)){this._bitIndex=16,this._bitValue=0;for(var o=0,u=0;u<240;u+=128)for(var f=0;f<320;f+=128)for(var h=0;h<128;h+=8){var l=u+h;if(l>=240)break;for(var d=0;d<128;d+=8){var c=f+d;if(c>=320)break;if(o)o-=1;else{var v=320*l+c,_=this._layers[n],y=this.readBits(3);if(0==y){var m=this._table1[this.readBits(5)],p=this._linetable.subarray(8*m,8*m+8);_.set(p,v),_.set(p,v+320),_.set(p,v+640),_.set(p,v+960),_.set(p,v+1280),_.set(p,v+1600),_.set(p,v+1920),_.set(p,v+2240)}else if(1==y){var b=this.readBits(13),g=this._linetable.subarray(8*b,8*b+8);_.set(g,v),_.set(g,v+320),_.set(g,v+640),_.set(g,v+960),_.set(g,v+1280),_.set(g,v+1600),_.set(g,v+1920),_.set(g,v+2240)}else if(2==y){var k=this.readBits(5),w=this._table1[k],U=this._table2[k],A=this._linetable.subarray(8*w,8*w+8),T=this._linetable.subarray(8*U,8*U+8);_.set(A,v),_.set(T,v+320),_.set(A,v+640),_.set(T,v+960),_.set(A,v+1280),_.set(T,v+1600),_.set(A,v+1920),_.set(T,v+2240)}else if(3==y){var F=this.readBits(13),P=this._table3[F],E=this._linetable.subarray(8*F,8*F+8),M=this._linetable.subarray(8*P,8*P+8);_.set(E,v),_.set(M,v+320),_.set(E,v+640),_.set(M,v+960),_.set(E,v+1280),_.set(M,v+1600),_.set(E,v+1920),_.set(M,v+2240)}else if(4==y)for(var S=this.readBits(8),L=0;L<8;L++){var x=0;x=S&1<<L?this._table1[this.readBits(5)]:this.readBits(13);var C=this._linetable.subarray(8*x,8*x+8);_.set(C,v+320*L)}else{if(5==y){o=this.readBits(5);continue}if(7==y){var O=this.readBits(2),I=0,D=0;this.readBits(1)?(I=this._table1[this.readBits(5)],D=this._table1[this.readBits(5)],O=(O+1)%4):(I=this.readBits(13),D=this.readBits(13));var R=this._linetable.subarray(8*I,8*I+8),B=this._linetable.subarray(8*D,8*D+8);0==O?(_.set(R,v),_.set(B,v+320),_.set(R,v+640),_.set(B,v+960),_.set(R,v+1280),_.set(B,v+1600),_.set(R,v+1920),_.set(B,v+2240)):1==O?(_.set(R,v),_.set(R,v+320),_.set(B,v+640),_.set(R,v+960),_.set(R,v+1280),_.set(B,v+1600),_.set(R,v+1920),_.set(R,v+2240)):2==O?(_.set(R,v),_.set(B,v+320),_.set(R,v+640),_.set(R,v+960),_.set(B,v+1280),_.set(R,v+1600),_.set(R,v+1920),_.set(B,v+2240)):3==O&&(_.set(R,v),_.set(B,v+320),_.set(B,v+640),_.set(R,v+960),_.set(B,v+1280),_.set(B,v+1600),_.set(R,v+1920),_.set(B,v+2240))}}}}}}}return this._prevDecodedFrame=e,[new Uint8Array(this._layers[0].buffer),new Uint8Array(this._layers[1].buffer),new Uint8Array(this._layers[2].buffer)]}},{key:"getFramePalette",value:function(e){var t=this.frameMeta[e].flags;return[o[15&t],o[t>>8&15],o[t>>12&15],o[t>>16&15],o[t>>20&15],o[t>>24&15],o[t>>28&15]]}},{key:"getFrameImage",value:function(e){for(var t=this.decodeFrame(e),r=new Uint8Array(76800),a=0;a<76800;a++){var i=t[0][a],n=t[1][a],s=t[2][a];s&&(r[a]=s+4),n&&(r[a]=n+2),i&&(r[a]=i)}return r}},{key:"decodeSoundFlags",value:function(){return this.frameMeta.map(function(e){var t=e.soundFlags;return[1&t,t>>1&1,t>>2&1,t>>3&1]})}},{key:"hasAudioTrack",value:function(e){var t=["bgm","se1","se2","se3","se4"][e];return this.soundMeta[t].length>0}},{key:"decodeAudio",value:function(e){for(var t,r,a,i=this.soundMeta[e],s=new Int16Array(981840),o=0,u=new Uint8Array(this.buffer,i.offset,i.length),f=0,h=40,l=0;l<u.length;l++)for(var d=u[l],c=0;c<8;)h<18||6==c?(t=d>>c&3,r=f+n.ADPCM_SAMPLE_TABLE_2[t+4*h],a=h+n.ADPCM_INDEX_TABLE_2[t],c+=2):(t=d>>c&15,r=f+n.ADPCM_SAMPLE_TABLE_4[t+16*h],a=h+n.ADPCM_INDEX_TABLE_4[t],c+=4),a=Math.max(0,Math.min(a,79)),r=Math.max(-2048,Math.min(r,2048)),s[o]=16*r,o+=1,h=a,f=r;return s.slice(0,o)}}]),t}();t.default=u},function(e,t,r){e.exports=r(7)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.kwzParser=t.ppmParser=t.parser=t.default=void 0;var a=o(r(8)),i=o(r(2)),n=o(r(3)),s=o(r(5));function o(e){return e&&e.__esModule?e:{default:e}}var u={version:"2.2.0",player:a.default,parser:i.default,ppmParser:n.default,kwzParser:s.default};t.default=u,t.parser=i.default,t.ppmParser=n.default,t.kwzParser=s.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),i=u(r(1)),n=u(r(2)),s=u(r(11)),o=u(r(15));u(r(1));function u(e){return e&&e.__esModule?e:{default:e}}var f=function(){function e(t,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t="string"==typeof t?document.querySelector(t):t,this.canvas=new i.default(t,r,a),this._imgCanvas=new i.default(document.createElement("canvas"),r,a,{antialias:!0,preserveDrawingBuffer:!0}),this._isOpen=!1,this._events={},this.loop=!1,this.currentFrame=0,this.paused=!0,this.audioTracks=[new o.default("se1"),new o.default("se2"),new o.default("se3"),new o.default("se4"),new o.default("bgm")],this.smoothRendering=!1}return a(e,[{key:"_load",value:function(e){var t=new n.default(e);this.note=t,this.meta=t.meta,this.type=t.type,this.frameCount=t.frameCount,this.frameSpeed=t.frameSpeed,this.fileLength=t.byteLength,this.loop=1==t.meta.loop,this.paused=!0,this._isOpen=!0,this.note.hasAudioTrack(1)&&this.audioTracks[0].set(this.note.decodeAudio("se1"),1),this.note.hasAudioTrack(2)&&this.audioTracks[1].set(this.note.decodeAudio("se2"),1),this.note.hasAudioTrack(3)&&this.audioTracks[2].set(this.note.decodeAudio("se3"),1),"KWZ"===this.type&&this.note.hasAudioTrack(4)&&this.audioTracks[3].set(this.note.decodeAudio("se4"),1),this.note.hasAudioTrack(0)&&this.audioTracks[4].set(this.note.decodeAudio("bgm"),this._audiorate),this._seFlags=this.note.decodeSoundFlags(),this._playbackLoop=null,this._hasPlaybackStarted=!1,this.layerVisiblity={1:!0,2:!0,3:!0},this.setMode(this.type),this.setFrame(this.note.thumbFrameIndex),this.emit("load")}},{key:"open",value:function(e){var t=this;return this._isOpen&&this.close(),(0,s.default)(e).then(function(e){t._load(e)}).catch(function(e){console.error("Error loading Flipnote:",e)})}},{key:"close",value:function(){this.pause(),this.note=null,this._isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.frameCount=null,this.frameSpeed=null,this._frame=0;for(var e=0;e<this.audioTracks.length;e++)this.audioTracks[e].unset();this._seFlags=null,this._hasPlaybackStarted=null,this.canvas.clear(),this._imgCanvas.clear()}},{key:"destroy",value:function(){this.close(),this.canvas.destroy(),this._imgCanvas.destroy()}},{key:"_playFrameSe",value:function(e){for(var t=this._seFlags[e],r=0;r<t.length;r++)t[r]&&this.audioTracks[r].active&&this.audioTracks[r].start()}},{key:"_playBgm",value:function(){this.audioTracks[4].start(this.currentTime)}},{key:"_stopAudio",value:function(){for(var e=0;e<this.audioTracks.length;e++)this.audioTracks[e].stop()}},{key:"play",value:function(){var e=this;if(!this._isOpen||!this.paused)return null;this.paused=!1,this._hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this._frame=0),this._playBgm(),this._playbackLoop=setInterval(function(){e.paused&&clearInterval(e._playbackLoop),e.currentFrame>=e.frameCount-1?(e._stopAudio(),e.loop?(e.firstFrame(),e._playBgm(0),e.emit("playback:loop")):(e.pause(),e.emit("playback:end"))):(e._playFrameSe(e.currentFrame),e.nextFrame())},1e3/this.framerate),this._hasPlaybackStarted=!0,this.emit("playback:start")}},{key:"pause",value:function(){if(!this._isOpen||this.paused)return null;clearInterval(this._playbackLoop),this.paused=!0,this._stopAudio(),this.emit("playback:stop")}},{key:"getFrameImage",value:function(e,t,r,a,i){if(!this._isOpen)return null;var n=this._imgCanvas;return n.width===t&&n.height===r||n.setSize(t,r),e="thumb"==e?this.note.thumbFrameIndex:Math.max(0,Math.min(e,this.frameCount-1)),this.drawFrame(e,n),n.toImage(a,i)}},{key:"setFrame",value:function(e){if(!this._isOpen||e===this.currentFrame)return null;e=Math.max(0,Math.min(Math.floor(e),this.frameCount-1)),this._frame=e,this._playbackFrameTime=0,this.drawFrame(e,this.canvas),this.emit("frame:update",this.currentFrame)}},{key:"drawFrame",value:function(e,t){var r=this.note.getFramePalette(e),a=this.note.decodeFrame(e);t.setPaperColor(r[0]),t.clear(),"PPM"==this.note.type?(this.layerVisiblity[2]&&t.drawLayer(a[1],256,192,r[2],[0,0,0,0]),this.layerVisiblity[1]&&t.drawLayer(a[0],256,192,r[1],[0,0,0,0])):"KWZ"==this.note.type&&(this.layerVisiblity[3]&&t.drawLayer(a[2],320,240,r[5],r[6]),this.layerVisiblity[2]&&t.drawLayer(a[1],320,240,r[3],r[4]),this.layerVisiblity[1]&&t.drawLayer(a[0],320,240,r[1],r[2]))}},{key:"thumbnailFrame",value:function(){this.currentFrame=this.note.thumbFrameIndex}},{key:"nextFrame",value:function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1}},{key:"prevFrame",value:function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1}},{key:"lastFrame",value:function(){this.currentFrame=this.frameCount-1}},{key:"firstFrame",value:function(){this.currentFrame=0}},{key:"resize",value:function(e,t){this.canvas.resize(e,t),this.forceUpdate()}},{key:"setLayerVisibility",value:function(e,t){this.layerVisiblity[e]=t,this.forceUpdate()}},{key:"setSmoothRendering",value:function(e){var t=e?"linear":"nearest";this.canvas.setFilter(t),this.forceUpdate(),this.smoothRendering=e}},{key:"setMode",value:function(e){this.canvas.setMode(e),this._imgCanvas.setMode(e)}},{key:"forceUpdate",value:function(){this._isOpen&&this.drawFrame(this.currentFrame,this.canvas)}},{key:"on",value:function(e,t){var r=this._events;(r[e]||(r[e]=[])).push(t)}},{key:"off",value:function(e,t){var r=this._events[e];r&&r.splice(r.indexOf(t),1)}},{key:"emit",value:function(e){for(var t=this._events[e]||[],r=arguments.length,a=Array(r>1?r-1:0),i=1;i<r;i++)a[i-1]=arguments[i];for(var n=0;n<t.length;n++)t[n].apply(null,a)}},{key:"currentFrame",get:function(){return this._frame},set:function(e){this.setFrame(e)}},{key:"currentTime",get:function(){return this._isOpen?this.currentFrame*(1/this.framerate):null},set:function(e){this._isOpen&&e<this.duration&&e>0&&this.setFrame(Math.round(e/(1/this.framerate)))}},{key:"volume",get:function(){return this.audioTracks[3].audio.volume},set:function(e){for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].audio.volume=e}},{key:"muted",get:function(){return this.audioTracks[3].audio.muted},set:function(e){for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].audio.muted=e}},{key:"duration",get:function(){return this._isOpen?this.frameCount*(1/this.framerate):null}},{key:"framerate",get:function(){return this.note.framerate}},{key:"_audiorate",get:function(){return 1/this.note.bgmrate/(1/this.note.framerate)}}]),e}();t.default=f},function(e,t){e.exports="#define GLSLIFY 1\nattribute vec4 a_position;\nvarying vec2 v_texcoord;\nvoid main() {\n  gl_Position = a_position;\n  v_texcoord = a_position.xy * vec2(0.5, -0.5) + 0.5;\n}"},function(e,t){e.exports="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texcoord;\nuniform vec4 u_color1;\nuniform vec4 u_color2;\nuniform sampler2D u_bitmap;\nuniform bool u_isSmooth;\nvoid main() {\n  float weightColor1 = texture2D(u_bitmap, v_texcoord).a;\n  float weightColor2 = texture2D(u_bitmap, v_texcoord).r;\n  float alpha = 1.0;\n  if (u_isSmooth) {\n    weightColor1 = smoothstep(0.0, .9, weightColor1);\n    weightColor2 = smoothstep(0.0, .9, weightColor2);\n    float alpha = weightColor1 + weightColor2;\n  }\n  gl_FragColor = vec4(u_color1.rgb, alpha) * weightColor1 + vec4(u_color2.rgb, alpha) * weightColor2;\n}\n"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return new Promise(function(t,r){for(var a=0;a<o.length;a++){var i=o[a];if(i.matches(e)){i.load(e,t,r);break}}})};var a=s(r(12)),i=s(r(13)),n=s(r(14));function s(e){return e&&e.__esModule?e:{default:e}}var o=[a.default,i.default,n.default]},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={matches:function(e){return"string"==typeof e},load:function(e,t,r){var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.onreadystatechange=function(e){4===a.readyState&&(a.status>=200&&a.status<300?t(a.response):r({type:"httpError",status:a.status,statusText:a.statusText}))},a.send(null)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={matches:function(e){return e instanceof File},load:function(e,t,r){var a=new FileReader;a.onload=function(e){t(e.target.result)},a.onerror=function(e){r({type:"fileReadError"})},a.readAsArrayBuffer(e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={matches:function(e){return e instanceof ArrayBuffer},load:function(e,t,r){t(e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),i=function(e){return e&&e.__esModule?e:{default:e}}(r(16));var n=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=t,this.channelCount=1,this.bitsPerSample=16,this.sampleRate="KWZ"===r?16364:8192,this.playbackRate=1,this.audio=document.createElement("audio"),this.audio.preload=!0,this.active=!1}return a(e,[{key:"set",value:function(e,t){var r=new i.default(this.sampleRate*t,this.channelCount,this.bitsPerSample);r.writeFrames(e),this.url=window.URL.createObjectURL(r.getBlob()),this.audio.src=this.url,this.active=!0,this.playbackRate=t,this.length=e.length}},{key:"unset",value:function(){this.active&&(window.URL.revokeObjectURL(this.url),this.audio.src="",this.audio.load(),this.active=!1,this.playbackRate=1,this.length=null)}},{key:"start",value:function(e){this.active&&(this.audio.currentTime=e||0,this.audio.play())}},{key:"stop",value:function(){this.active&&this.audio.pause()}},{key:"duration",get:function(){return this.audio.duration}}]),e}();t.default=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),i=function(e){return e&&e.__esModule?e:{default:e}}(r(0));var n=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.sampleRate=t,this.channels=r,this.bitsPerSample=a;var n=new ArrayBuffer(44),s=new i.default(n);s.writeUtf8("RIFF"),s.writeUint32(0),s.writeUtf8("WAVE"),s.writeUtf8("fmt "),s.writeUint32(16),s.writeUint16(1),s.writeUint16(this.channels),s.writeUint32(this.sampleRate),s.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),s.writeUint16(this.bitsPerSample*this.channels/8),s.writeUint16(this.bitsPerSample),s.writeUtf8("data"),s.writeUint32(0),this.header=s,this.pcmData=null}return a(e,[{key:"writeFrames",value:function(e){var t=this.header;t.seek(4),t.writeUint32(t.byteLength+e.byteLength),t.seek(40),t.writeUint32(e.byteLength),this.pcmData=e}},{key:"getBlob",value:function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})}}]),e}();t.default=n}]).default});
//# sourceMappingURL=flipnote.min.js.map