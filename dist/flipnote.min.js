/*!
 * flipnote.js v2.0.1
 * Real-time, browser-based playback of Flipnote Studio's .ppm animation format
 * 2018 James Daniel
 * github.com/jaames/flipnote.js
 * Flipnote Studio is (c) Nintendo Co., Ltd.
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.flipnote=t():e.flipnote=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(i){if(r[i])return r[i].exports;var a=r[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,t),a.l=!0,a.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,i){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var r=e&&e.e?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=2)}([function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=function(){function e(t){i(this,e),this.buffer=t,this.t=new DataView(t),this.r=0}return a(e,[{key:"seek",value:function(e,t){switch(t){case 2:this.r=this.t.byteLength+e;break;case 1:this.r+=e;break;case 0:default:this.r=e}}},{key:"readUint8",value:function(){var e=this.t.getUint8(this.r);return this.r+=1,e}},{key:"writeUint8",value:function(e){this.t.setUint8(this.r,e),this.r+=1}},{key:"readInt8",value:function(){var e=this.t.getInt8(this.r);return this.r+=1,e}},{key:"writeInt8",value:function(e){this.t.setInt8(this.r,e),this.r+=1}},{key:"readUint16",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.t.getUint16(this.r,e);return this.r+=2,t}},{key:"writeUint16",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.t.setUint16(this.r,e,t),this.r+=2}},{key:"readInt16",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.t.getInt16(this.r,e);return this.r+=2,t}},{key:"writeInt16",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.t.setInt16(this.r,e,t),this.r+=2}},{key:"readUint32",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.t.getUint32(this.r,e);return this.r+=4,t}},{key:"writeUint32",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.t.setUint32(this.r,e,t),this.r+=4}},{key:"readInt32",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.t.getInt32(this.r,e);return this.r+=4,t}},{key:"writeInt32",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.t.setInt32(this.r,e,t),this.r+=4}},{key:"readHex",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=new Uint8Array(this.t.buffer,this.r,e);this.r+=r.byteLength;for(var i=[],a=0;a<r.length;a++)i.push(r[a].toString(16).padStart(2,"0"));return t&&i.reverse(),i.join("").toUpperCase()}},{key:"readUtf8",value:function(e){var t=new Uint8Array(this.t.buffer,this.r,e);this.r+=t.byteLength;for(var r="",i=0;i<t.length;i++){var a=t[i];if(0==a)break;r+=String.fromCharCode(a)}return r}},{key:"writeUtf8",value:function(e){for(var t=0;t<e.length;t++){var r=e.charCodeAt(t);this.writeUint8(r)}}},{key:"readUtf16",value:function(e){var t=new Uint16Array(this.t.buffer,this.r,e);this.r+=t.byteLength;for(var r="",i=0;i<t.length;i++){var a=t[i];if(0==a)break;r+=String.fromCharCode(a)}return r}},{key:"byteLength",get:function(){return this.t.byteLength}}]),e}();t.default=n},function(e,t,r){"use strict";function i(e){return e&&e.e?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=r(4),o=i(s),u=r(5),f=i(u),h=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:640,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:480,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{antialias:!1};a(this,e),this.width=t.width=r,this.height=t.height=i;var s=t.getContext("webgl",n),u=s.createProgram();this.program=u,this.el=t,this.gl=s,this.refs={shaders:[],textures:[],buffers:[]};var h=this.a(s.VERTEX_SHADER,o.default),l=this.a(s.FRAGMENT_SHADER,f.default);if(s.attachShader(u,h),s.attachShader(u,l),s.linkProgram(u),!s.getProgramParameter(u,s.LINK_STATUS))throw new Error(s.getProgramInfoLog(u));s.useProgram(u);var c=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,c),s.bufferData(s.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),s.STATIC_DRAW),s.enableVertexAttribArray(0),s.vertexAttribPointer(0,2,s.FLOAT,!1,0,0),this.refs.buffers.push(c),s.activeTexture(s.TEXTURE0);var d=s.createTexture();s.bindTexture(s.TEXTURE_2D,d),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.uniform1i(s.getUniformLocation(this.program,"u_bitmap"),0),this.setFilter("nearest"),this.refs.textures.push(d),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA)}return n(e,[{key:"_createShader",value:function(e,t){var r=this.gl,i=r.createShader(e);if(r.shaderSource(i,t),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(i));return this.refs.shaders.push(i),i}},{key:"toImage",value:function(e,t){return this.el.toDataURL(e,t)}},{key:"setFilter",value:function(e){var t=this.gl;e="linear"==e?t.LINEAR:t.NEAREST,t.activeTexture(t.TEXTURE0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e)}},{key:"setColor",value:function(e,t){this.gl.uniform4f(this.gl.getUniformLocation(this.program,e),t[0]/255,t[1]/255,t[2]/255,1)}},{key:"setPaperColor",value:function(e){this.gl.clearColor(e[0]/255,e[1]/255,e[2]/255,e[3]/255)}},{key:"drawLayer",value:function(e,t,r,i,a,n){var s=this.gl;s.activeTexture(s.TEXTURE0),s.texImage2D(s.TEXTURE_2D,0,s.ALPHA,t,r,0,s.ALPHA,s.UNSIGNED_BYTE,e),this.setColor("u_color1",i),this.setColor("u_color2",a),s.drawArrays(s.TRIANGLES,0,6)}},{key:"resize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:640,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:480;this.el.width=e,this.el.height=t,this.width=e,this.height=t,this.gl.viewport(0,0,e,t)}},{key:"clear",value:function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}},{key:"destroy",value:function(){var e=this.refs,t=this.gl;e.shaders.forEach(function(e){t.deleteShader(e)}),e.shaders=[],e.textures.forEach(function(e){t.deleteTexture(e)}),e.textures=[],e.buffers.forEach(function(e){t.deleteBuffer(e)}),e.buffers=[],t.deleteProgram(this.program),t.canvas.width=1,t.canvas.height=1}}]),e}();t.default=h},function(e,t,r){"use strict";var i=r(3),a=function(e){return e&&e.e?e:{default:e}}(i);e.exports={version:"2.0.1",player:a.default}},function(e,t,r){"use strict";function i(e){return e&&e.e?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=r(1),o=i(s),u=r(6),f=i(u),h=r(10),l=i(h),c=r(14),d=i(c),v=r(1),y=(i(v),function(){function e(t,r,i){a(this,e),t="string"==typeof t?document.querySelector(t):t,this.canvas=new o.default(t,r,i),this.u=new o.default(document.createElement("canvas"),r,i,{antialias:!0,preserveDrawingBuffer:!0}),this.f=!1,this.h={},this.loop=!1,this.currentFrame=0,this.paused=!0,this.audioTracks=[new d.default("se1"),new d.default("se2"),new d.default("se3"),new d.default("bgm")],this.smoothRendering=!1}return n(e,[{key:"_load",value:function(e){var t=new f.default(e);this.note=t,this.meta=t.meta,this.type=t.type,this.frameCount=t.frameCount,this.frameSpeed=t.frameSpeed,this.fileLength=t.byteLength,this.loop=1==t.meta.loop,this.paused=!0,this.f=!0,this.note.hasAudioTrack(1)&&this.audioTracks[0].set(this.note.decodeAudio("se1"),1),this.note.hasAudioTrack(2)&&this.audioTracks[1].set(this.note.decodeAudio("se2"),1),this.note.hasAudioTrack(3)&&this.audioTracks[2].set(this.note.decodeAudio("se3"),1),this.note.hasAudioTrack(0)&&this.audioTracks[3].set(this.note.decodeAudio("bgm"),this.v),this.y=this.note.decodeSoundFlags(),this._=null,this.b=!1,this.layerVisiblity={1:!0,2:!0,3:!0},this.setFrame(this.note.thumbFrameIndex),this.emit("load")}},{key:"open",value:function(e){var t=this;return this.f&&this.close(),(0,l.default)(e).then(function(e){t.g(e)}).catch(function(e){console.error("Error loading Flipnote:",e)})}},{key:"close",value:function(){this.pause(),this.note=null,this.f=!1,this.paused=!0,this.loop=null,this.meta=null,this.frameCount=null,this.frameSpeed=null,this.k=0;for(var e=0;e<this.audioTracks.length;e++)this.audioTracks[e].unset();this.y=null,this.b=null,this.canvas.clear(),this.u.clear()}},{key:"destroy",value:function(){this.close(),this.canvas.destroy(),this.u.destroy()}},{key:"_playFrameSe",value:function(e){for(var t=this.y[e],r=0;r<t.length;r++)t[r]&&this.audioTracks[r].active&&this.audioTracks[r].start()}},{key:"_playBgm",value:function(){this.audioTracks[3].start(this.currentTime)}},{key:"_stopAudio",value:function(){for(var e=0;e<this.audioTracks.length;e++)this.audioTracks[e].stop()}},{key:"play",value:function(){var e=this;if(!this.f||!this.paused)return null;this.paused=!1,this.b&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.k=0),this.w(),this._=setInterval(function(){e.paused&&clearInterval(e._),e.currentFrame>=e.frameCount-1?(e.U(),e.loop?(e.firstFrame(),e.w(0),e.emit("playback:loop")):(e.pause(),e.emit("playback:end"))):(e.F(e.currentFrame),e.nextFrame())},1e3/this.framerate),this.b=!0,this.emit("playback:start")}},{key:"pause",value:function(){if(!this.f||this.paused)return null;clearInterval(this._),this.paused=!0,this.U(),this.emit("playback:stop")}},{key:"getFrameImage",value:function(e,t,r,i,a){if(!this.f)return null;var n=this.u;return n.width===t&&n.height===r||n.setSize(t,r),e="thumb"==e?this.note.thumbFrameIndex:Math.max(0,Math.min(e,this.frameCount-1)),this.drawFrame(e,n),n.toImage(i,a)}},{key:"setFrame",value:function(e){if(!this.f||e===this.currentFrame)return null;e=Math.max(0,Math.min(Math.floor(e),this.frameCount-1)),this.k=e,this.T=0,this.drawFrame(e,this.canvas),this.emit("frame:update",this.currentFrame)}},{key:"drawFrame",value:function(e,t){var r=this.note.getFramePalette(e),i=this.note.decodeFrame(e);t.setPaperColor(r[0]),t.clear(),"PPM"==this.note.type?(this.layerVisiblity[2]&&t.drawLayer(i[1],256,192,r[2],[0,0,0,0]),this.layerVisiblity[1]&&t.drawLayer(i[0],256,192,r[1],[0,0,0,0])):"KWZ"==this.note.type&&(this.layerVisiblity[3]&&t.drawLayer(i[2],320,240,r[5],r[6]),this.layerVisiblity[2]&&t.drawLayer(i[1],320,240,r[3],r[4]),this.layerVisiblity[1]&&t.drawLayer(i[0],320,240,r[1],r[2]))}},{key:"thumbnailFrame",value:function(){this.currentFrame=this.note.thumbFrameIndex}},{key:"nextFrame",value:function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1}},{key:"prevFrame",value:function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1}},{key:"lastFrame",value:function(){this.currentFrame=this.frameCount-1}},{key:"firstFrame",value:function(){this.currentFrame=0}},{key:"resize",value:function(e,t){this.canvas.resize(e,t)}},{key:"setLayerVisibility",value:function(e,t){this.layerVisiblity[e]=t,this.drawFrame(this.currentFrame,this.canvas)}},{key:"setSmoothRendering",value:function(e){if("KWZ"==this.type)var t="nearest";else var t=e?"linear":"nearest";this.canvas.setFilter(t),this.drawFrame(this.currentFrame,this.canvas),this.smoothRendering=e}},{key:"on",value:function(e,t){var r=this.h;(r[e]||(r[e]=[])).push(t)}},{key:"off",value:function(e,t){var r=this.h[e];r&&r.splice(r.indexOf(t),1)}},{key:"emit",value:function(e){for(var t=this.h[e]||[],r=arguments.length,i=Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];for(var n=0;n<t.length;n++)t[n].apply(null,i)}},{key:"currentFrame",get:function(){return this.k},set:function(e){this.setFrame(e)}},{key:"currentTime",get:function(){return this.f?this.currentFrame*(1/this.framerate):null},set:function(e){this.f&&e<this.duration&&e>0&&this.setFrame(Math.round(e/(1/this.framerate)))}},{key:"volume",get:function(){return this.audioTracks[3].audio.volume},set:function(e){for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].audio.volume=e}},{key:"muted",get:function(){return this.audioTracks[3].audio.muted},set:function(e){for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].audio.muted=e}},{key:"duration",get:function(){return this.f?this.frameCount*(1/this.framerate):null}},{key:"framerate",get:function(){return this.note.framerate}},{key:"_audiorate",get:function(){return 1/this.note.bgmrate/(1/this.note.framerate)}}]),e}());t.default=y},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default="\nattribute vec4 a_position;\nvarying vec2 v_texcoord;\nvoid main() {\n  gl_Position = a_position;\n  v_texcoord = a_position.xy * vec2(0.5, -0.5) + 0.5;\n}"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default="\nprecision mediump float;\nvarying vec2 v_texcoord;\nuniform vec4 u_color1;\nuniform vec4 u_color2;\nuniform sampler2D u_bitmap;\nvoid main() {\n  float index = texture2D(u_bitmap, v_texcoord).a * 255.0;\n  float weightColor1 = smoothstep(0.0, 1.0, index);\n  float weightColor2 = smoothstep(1.0, 2.0, index);\n  gl_FragColor = mix(vec4(0, 0, 0, 0), mix(u_color1, u_color2, weightColor2), weightColor1);\n}"},function(e,t,r){"use strict";function i(e){return e&&e.e?e:{default:e}}function a(e){var t=new DataView(e,0,4),r=t.getUint32(0);return 1346458177==r?new s.default(e):1262897152==(4294967040&r)?new u.default(e):void 0}Object.defineProperty(t,"__esModule",{value:!0}),t.default=a;var n=r(7),s=i(n),o=r(9),u=i(o)},function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=r(0),u=function(e){return e&&e.e?e:{default:e}}(o),f=r(8),h={1:.5,2:1,3:2,4:4,5:6,6:12,7:20,8:30},l=256,c=192,d=[14,14,14],v=[255,255,255],y=[10,57,255],m=[255,42,42],_=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r.type="PPM",r.seek(4),r.A=r.readUint32(),r.x=r.readUint32(),r.frameCount=Math.min(r.readUint16()+1,999),r.seek(18),r.thumbFrameIndex=r.readUint16(),r.seek(1696);var n=r.readUint16();return r.seek(1704),r.P=new Uint32Array(n/4).map(function(e){return 1704+n+r.readUint32()}),r.S(),r.meta=r.O(),r.L=[new Uint8Array(l*c),new Uint8Array(l*c)],r.M=[new Uint8Array(l*c),new Uint8Array(l*c)],r.C=0,r}return n(t,e),s(t,[{key:"readFilename",value:function(){return[this.readHex(3),this.readUtf8(13),this.readUint16().toString().padStart(3,"0")].join("_")}},{key:"readLineEncoding",value:function(){for(var e=new Uint8Array(c),t=0;t<48;t++)for(var r=this.readUint8(),i=0;i<8;i+=2)e[4*t+i/2]=r>>i&3;return e}},{key:"_decodeMeta",value:function(){this.seek(16);var e=this.readUint16(),t=this.readInt16(),r=this.readUtf16(11),i=this.readUtf16(11),a=this.readUtf16(11),n=this.readHex(8,!0),s=this.readHex(8,!0),o=this.readFilename(),u=this.readFilename(),f=this.readHex(8,!0);this.seek(154);var h=new Date(1e3*(this.readUint32()+946684800));return this.seek(1702),{lock:e,loop:this.readUint16()>>1&1,frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:t,timestamp:h,spinoff:s!==n||s!==f,root:{filename:null,username:r,fsid:f},parent:{username:i,fsid:n,filename:o},current:{username:a,fsid:s,filename:u}}}},{key:"_decodeSoundHeader",value:function(){var e=1696+this.A+this.frameCount;e%4!=0&&(e+=4-e%4),this.seek(e);var t=this.readUint32(),r=this.readUint32(),i=this.readUint32(),a=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),e+=32,this.framerate=h[this.frameSpeed],this.bgmrate=h[this.bgmSpeed],this.soundMeta={bgm:{offset:e,length:t},se1:{offset:e+=t,length:r},se2:{offset:e+=r,length:i},se3:{offset:e+=i,length:a}}}},{key:"isNewFrame",value:function(e){return this.seek(this.P[e]),this.readUint8()>>7&1}},{key:"getFramePalette",value:function(e){this.seek(this.P[e]);var t=this.readUint8(),r=1&t,i=[null,1==r?d:v,m,y];return[1==r?v:d,i[t>>1&3],i[t>>3&3]]}},{key:"decodeFrame",value:function(e){0===e||this.C===e-1||this.isNewFrame(e)||this.decodeFrame(e-1),this.seek(this.P[e]);var t=this.readUint8(),r=t>>7&1,i=t>>5&3,a=0,n=0;this.M[0].set(this.L[0]),this.M[1].set(this.L[1]),this.C=e,this.L[0].fill(0),this.L[1].fill(0),i&&(a=this.readInt8(),n=this.readInt8());for(var s=[this.readLineEncoding(),this.readLineEncoding()],o=0;o<2;o++)for(var u=this.L[o],f=0;f<c;f++){var h=f*l,d=s[o][f];switch(d){case 0:break;case 1:case 2:var v=this.readUint32(!1);for(2==d&&u.fill(1,h,h+l);4294967295&v;){if(2147483648&v)for(var y=this.readUint8(),m=0;m<8;m++)u[h+m]=y>>m&1;h+=8,v<<=1}break;case 3:for(;h<(f+1)*l;){for(var y=this.readUint8(),m=0;m<8;m++)u[h+m]=y>>m&1;h+=8}}}if(!r)for(var _,p,b=0;b<c;b++)for(var g=0;g<l;g++)_=g+b*l,p=_-(a+n*l),g-a>l||g-a<0||(this.L[0][_]^=this.M[0][p],this.L[1][_]^=this.M[1][p]);return this.L}},{key:"hasAudioTrack",value:function(e){var t=["bgm","se1","se2","se3"][e];return this.soundMeta[t].length>0}},{key:"decodeAudio",value:function(e){var t=this.soundMeta[e],r=new Uint8Array(this.buffer,t.offset,t.length);return(0,f.decodeAdpcm)(r)}},{key:"decodeSoundFlags",value:function(){var e=this;return this.seek(1696+this.A),new Array(this.frameCount).fill([]).map(function(t){var r=e.readUint8();return[1&r,r>>1&1,r>>2&1]})}}],[{key:"validateFSID",value:function(e){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(e)}},{key:"validateFilename",value:function(e){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(e)}}]),t}(u.default);t.default=_},function(e,t,r){"use strict";function i(e){u=0,f=0;for(var t=new Int16Array(2*e.length),r=0,i=0;i<e.length;i++){var n=e[i];t[r]=a(15&n),t[r+1]=a(n>>4&15),r+=2}return t}function a(e){var t=u,r=f,i=o[r],a=i>>3;return 4&e&&(a+=i),2&e&&(a+=i>>1),1&e&&(a+=i>>2),t+=8&e?-a:a,r+=s[e],r=n(r,0,88),t=n(t,-32767,32767),u=t,f=r,t}function n(e,t,r){return e<=t?t:e>=r?r:e}Object.defineProperty(t,"__esModule",{value:!0}),t.decodeAdpcm=i;var s=[-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8],o=[7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767],u=0,f=0},function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=r(0),u=function(e){return e&&e.e?e:{default:e}}(o),f=[.2,.5,1,2,4,6,8,12,20,24,30],h=[[255,255,255],[16,16,16],[255,16,16],[255,231,0],[0,134,49],[0,56,206],[255,255,255]],l=function(e){function t(e){i(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r.type="KWZ",r.R=new Uint16Array([0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740]),r.I=new Uint16Array([0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100]),r.j=new Uint16Array(6561);for(var n=[0,3,7,1,4,8,2,5,6],s=0,o=0;o<9;o++)for(var u=0;u<9;u++)for(var f=0;f<9;f++)for(var h=0;h<9;h++)r.j[s]=9*(9*(9*n[o]+n[u])+n[f])+n[h],s++;r.D=new Uint8Array(52488);for(var l=0,c=0;c<3;c++)for(var d=0;d<3;d++)for(var v=0;v<3;v++)for(var y=0;y<3;y++)for(var m=0;m<3;m++)for(var _=0;_<3;_++)for(var p=0;p<3;p++)for(var b=0;b<3;b++)r.D.set([d,c,y,v,_,m,b,p],l),l+=8;return r.L=[new Uint8Array(76800),new Uint8Array(76800),new Uint8Array(76800)],r.B=0,r.V=0,r.load(),r}return n(t,e),s(t,[{key:"load",value:function(){this.seek(0),this.sections={};for(var e=this.byteLength-256,t=0,r=0;t<e&&r<6;){this.seek(t);var i=this.readUtf8(4).substring(0,3),a=this.readUint32();this.sections[i]={offset:t,length:a},t+=a+8,r+=1}this.meta=this.O(),this.frameMeta=[],this.frameOffsets=[],this.seek(this.sections.KMI.offset+8),t=this.sections.KMC.offset+12;for(var n=0;n<this.frameCount;n++){var s={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readUtf8(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(s),this.frameOffsets.push(t),t+=s.layerSize[0]+s.layerSize[1]+s.layerSize[2]}this.H=-1}},{key:"readBits",value:function(e){if(this.B+e>16){var t=this.readUint16();this.V|=t<<16-this.B,this.B-=16}var r=(1<<e)-1,i=this.V&r;return this.V>>=e,this.B+=e,i}},{key:"_decodeMeta",value:function(){this.seek(this.sections.KFH.offset+12);var e=new Date(1e3*(this.readUint32()+946684800)),t=new Date(1e3*(this.readUint32()+946684800)),r=(this.readUint32(),this.readHex(10)),i=this.readHex(10),a=this.readHex(10),n=this.readUtf16(11),s=this.readUtf16(11),o=this.readUtf16(11),u=this.readUtf8(28),h=this.readUtf8(28),l=this.readUtf8(28),c=this.readUint16(),d=this.readUint16(),v=this.readUint16(),y=this.readUint8();this.readUint8();return this.frameCount=c,this.thumbFrameIndex=d,this.frameSpeed=y,this.framerate=f[y],{lock:1&v,loop:v>>1&1,frame_count:c,frame_speed:y,thumb_index:d,timestamp:t,creation_timestamp:e,root:{username:n,fsid:r,filename:u},parent:{username:s,fsid:i,filename:h},current:{username:o,fsid:a,filename:l}}}},{key:"getDiffingFlag",value:function(e){return 7&~(this.frameMeta[e].flags>>4)}},{key:"getLayerDepths",value:function(e){return this.frameMeta[e].layerDepth}},{key:"decodeFrame",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];r&&(t&=this.getDiffingFlag(e+1)),0!==e&&this.H!==e-1&&t&&this.decodeFrame(e-1,t=t,r=!0);for(var i=this.frameMeta[e],a=this.frameOffsets[e],n=0;n<3;n++){this.seek(a);var s=i.layerSize[n];if(a+=s,38!==s&&!(t>>n&!1)){this.B=16,this.V=0;for(var o=0,u=0;u<240;u+=128)for(var f=0;f<320;f+=128)for(var h=0;h<128;h+=8){var l=u+h;if(l>=240)break;for(var c=0;c<128;c+=8){var d=f+c;if(d>=320)break;if(o)o-=1;else{var v=320*l+d,y=this.L[n],m=this.readBits(3);if(0==m){var _=this.R[this.readBits(5)],p=this.D.subarray(8*_,8*_+8);y.set(p,v),y.set(p,v+320),y.set(p,v+640),y.set(p,v+960),y.set(p,v+1280),y.set(p,v+1600),y.set(p,v+1920),y.set(p,v+2240)}else if(1==m){var b=this.readBits(13),g=this.D.subarray(8*b,8*b+8);y.set(g,v),y.set(g,v+320),y.set(g,v+640),y.set(g,v+960),y.set(g,v+1280),y.set(g,v+1600),y.set(g,v+1920),y.set(g,v+2240)}else if(2==m){var k=this.readBits(5),w=this.R[k],U=this.I[k],F=this.D.subarray(8*w,8*w+8),T=this.D.subarray(8*U,8*U+8);y.set(F,v),y.set(T,v+320),y.set(F,v+640),y.set(T,v+960),y.set(F,v+1280),y.set(T,v+1600),y.set(F,v+1920),y.set(T,v+2240)}else if(3==m){var A=this.readBits(13),E=this.j[A],x=this.D.subarray(8*A,8*A+8),P=this.D.subarray(8*E,8*E+8);y.set(x,v),y.set(P,v+320),y.set(x,v+640),y.set(P,v+960),y.set(x,v+1280),y.set(P,v+1600),y.set(x,v+1920),y.set(P,v+2240)}else if(4==m)for(var S=this.readBits(8),O=0;O<8;O++){var L=0;L=S&1<<O?this.R[this.readBits(5)]:this.readBits(13);var M=this.D.subarray(8*L,8*L+8);y.set(M,v+320*O)}else{if(5==m){o=this.readBits(5);continue}if(6==m)console.warn("type 6??? nah m8");else if(7==m){var C=this.readBits(2),R=this.readBits(1),I=0,j=0;R?(I=this.R[this.readBits(5)],j=this.R[this.readBits(5)],C=(C+1)%4):(I=this.readBits(13),j=this.readBits(13));var D=this.D.subarray(8*I,8*I+8),B=this.D.subarray(8*j,8*j+8);0==C?(y.set(D,v),y.set(B,v+320),y.set(D,v+640),y.set(B,v+960),y.set(D,v+1280),y.set(B,v+1600),y.set(D,v+1920),y.set(B,v+2240)):1==C?(y.set(D,v),y.set(D,v+320),y.set(B,v+640),y.set(D,v+960),y.set(D,v+1280),y.set(B,v+1600),y.set(D,v+1920),y.set(D,v+2240)):2==C?(y.set(D,v),y.set(B,v+320),y.set(D,v+640),y.set(D,v+960),y.set(B,v+1280),y.set(D,v+1600),y.set(D,v+1920),y.set(B,v+2240)):3==C&&(y.set(D,v),y.set(B,v+320),y.set(B,v+640),y.set(D,v+960),y.set(B,v+1280),y.set(B,v+1600),y.set(D,v+1920),y.set(B,v+2240))}}}}}}}return this.H=e,this.L}},{key:"getFramePalette",value:function(e){var t=this.frameMeta[e].flags;return[h[15&t],h[t>>8&15],h[t>>12&15],h[t>>16&15],h[t>>20&15],h[t>>24&15],h[t>>28&15]]}},{key:"getFrameImage",value:function(e){for(var t=this.decodeFrame(e),r=new Uint8Array(76800),i=0;i<76800;i++){var a=t[0][i],n=t[1][i],s=t[2][i];s&&(r[i]=s+4),n&&(r[i]=n+2),a&&(r[i]=a)}return r}},{key:"decodeSoundFlags",value:function(){return new Array(this.frameCount).fill([]).map(function(e){return[!1,!1,!1]})}},{key:"hasAudioTrack",value:function(e){return!1}}]),t}(u.default);t.default=l},function(e,t,r){"use strict";function i(e){return e&&e.e?e:{default:e}}function a(e){return new Promise(function(t,r){for(var i=0;i<l.length;i++){var a=l[i];if(a.matches(e)){a.load(e,t,r);break}}})}Object.defineProperty(t,"__esModule",{value:!0}),t.default=a;var n=r(11),s=i(n),o=r(12),u=i(o),f=r(13),h=i(f),l=[s.default,u.default,h.default]},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={matches:function(e){return"string"==typeof e},load:function(e,t,r){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onreadystatechange=function(e){4===i.readyState&&(i.status>=200&&i.status<300?t(i.response):r({type:"httpError",status:i.status,statusText:i.statusText}))},i.send(null)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={matches:function(e){return e instanceof File},load:function(e,t,r){var i=new FileReader;i.onload=function(e){t(e.target.result)},i.onerror=function(e){r({type:"fileReadError"})},i.readAsArrayBuffer(e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={matches:function(e){return e instanceof ArrayBuffer},load:function(e,t,r){t(e)}}},function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=r(15),s=function(e){return e&&e.e?e:{default:e}}(n),o=function(){function e(t){i(this,e),this.id=t,this.channelCount=1,this.bitsPerSample=16,this.sampleRate=8192,this.playbackRate=1,this.audio=document.createElement("audio"),this.audio.preload=!0,this.active=!1}return a(e,[{key:"set",value:function(e,t){var r=new s.default(this.sampleRate*t,this.channelCount,this.bitsPerSample);r.writeFrames(e),this.url=window.URL.createObjectURL(r.getBlob()),this.audio.src=this.url,this.active=!0,this.playbackRate=t,this.length=e.length}},{key:"unset",value:function(){this.active&&(window.URL.revokeObjectURL(this.url),this.audio.src="",this.audio.load(),this.active=!1,this.playbackRate=1,this.length=null)}},{key:"start",value:function(e){this.active&&(this.audio.currentTime=e||0,this.audio.play())}},{key:"stop",value:function(){this.active&&this.audio.pause()}},{key:"duration",get:function(){return this.audio.duration}}]),e}();t.default=o},function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=r(0),s=function(e){return e&&e.e?e:{default:e}}(n),o=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16;i(this,e),this.sampleRate=t,this.channels=r,this.bitsPerSample=a;var n=new ArrayBuffer(44),o=new s.default(n);o.writeUtf8("RIFF"),o.writeUint32(0),o.writeUtf8("WAVE"),o.writeUtf8("fmt "),o.writeUint32(16),o.writeUint16(1),o.writeUint16(this.channels),o.writeUint32(this.sampleRate),o.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),o.writeUint16(this.bitsPerSample*this.channels/8),o.writeUint16(this.bitsPerSample),o.writeUtf8("data"),o.writeUint32(0),this.header=o,this.pcmData=null}return a(e,[{key:"writeFrames",value:function(e){var t=this.header;t.seek(4),t.writeUint32(t.byteLength+e.byteLength),t.seek(40),t.writeUint32(e.byteLength),this.pcmData=e}},{key:"getBlob",value:function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})}}]),e}();t.default=o}])});