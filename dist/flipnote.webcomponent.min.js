/*!!
 flipnote.js v4.0.3 (webcomponent ver)
 Browser-based playback of .ppm and .kwz animations from Flipnote Studio and Flipnote Studio 3D
 2018 - 2020 James Daniel
 github.com/jaames/flipnote.js
 Flipnote Studio is (c) Nintendo Co., Ltd.
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t=t||self).flipnote={})}(this,(function(t){"use strict";function i(){}function n(t){return t()}function s(){return Object.create(null)}function r(t){t.forEach(n)}function e(t){return"function"==typeof t}function h(t,i){return t!=t?i==i:t!==i||t&&"object"==typeof t||"function"==typeof t}function o(t,i){t.appendChild(i)}function u(t,i,n){t.insertBefore(i,n||null)}function a(t){t.parentNode.removeChild(t)}function f(t){return document.createElement(t)}function c(t){return document.createTextNode(t)}function l(){return c(" ")}function v(t,i,n,s){return t.addEventListener(i,n,s),()=>t.removeEventListener(i,n,s)}function d(t,i,n){null==n?t.removeAttribute(i):t.getAttribute(i)!==n&&t.setAttribute(i,n)}function p(t,i,n){i in t?t[i]=n:d(t,i,n)}function y(t,i){i=""+i,t.wholeText!==i&&(t.data=i)}function w(t,i,n,s){t.style.setProperty(i,n,s?"important":"")}let m;function b(t){m=t}function g(){if(!m)throw new Error("Function called outside component initialization");return m}function _(){const t=g();return(i,n)=>{const s=t.$$.callbacks[i];if(s){const r=function(t,i){const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,!1,!1,i),n}(i,n);s.slice().forEach(i=>{i.call(t,r)})}}}const A=[],x=[],U=[],k=[],P=Promise.resolve();let S=!1;function E(t){U.push(t)}let F=!1;const M=new Set;function C(){if(!F){F=!0;do{for(let t=0;t<A.length;t+=1){const i=A[t];b(i),j(i.$$)}for(A.length=0;x.length;)x.pop()();for(let t=0;t<U.length;t+=1){const i=U[t];M.has(i)||(M.add(i),i())}U.length=0}while(A.length);for(;k.length;)k.pop()();S=!1,F=!1,M.clear()}}function j(t){if(null!==t.fragment){t.update(),r(t.before_update);const i=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,i),t.after_update.forEach(E)}}const B=new Set;let I,O;function L(t,i){t&&t.i&&(B.delete(t),t.i(i))}function D(t,i){const n=i.token={};function s(t,s,e,h){if(i.token!==n)return;i.resolved=h;let o=i.ctx;void 0!==e&&(o=o.slice(),o[e]=h);const u=t&&(i.current=t)(o);let a=!1;i.block&&(i.blocks?i.blocks.forEach((t,n)=>{n!==s&&t&&(I={r:0,c:[],p:I},function(t,i,n,s){if(t&&t.o){if(B.has(t))return;B.add(t),I.c.push(()=>{B.delete(t),s&&(n&&t.d(1),s())}),t.o(i)}}(t,1,1,()=>{i.blocks[n]=null}),I.r||r(I.c),I=I.p)}):i.block.d(1),u.c(),L(u,1),u.m(i.mount(),i.anchor),a=!0),i.block=u,i.blocks&&(i.blocks[s]=u),a&&C()}if((e=t)&&"object"==typeof e&&"function"==typeof e.then){const n=g();if(t.then(t=>{b(n),s(i.then,1,i.value,t),b(null)},t=>{b(n),s(i.catch,2,i.error,t),b(null)}),i.current!==i.pending)return s(i.pending,0),!0}else{if(i.current!==i.then)return s(i.then,1,i.value,t),!0;i.resolved=t}var e}function W(t,i){-1===t.$$.dirty[0]&&(A.push(t),S||(S=!0,P.then(C)),t.$$.dirty.fill(0)),t.$$.dirty[i/31|0]|=1<<i%31}function z(t,h,o,u,f,c,l=[-1]){const v=m;b(t);const d=h.props||{},p=t.$$={fragment:null,ctx:null,props:c,update:i,not_equal:f,bound:s(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(v?v.$$.context:[]),callbacks:s(),dirty:l};let y=!1;if(p.ctx=o?o(t,d,(i,n,...s)=>{const r=s.length?s[0]:n;return p.ctx&&f(p.ctx[i],p.ctx[i]=r)&&(p.bound[i]&&p.bound[i](r),y&&W(t,i)),n}):[],p.update(),y=!0,r(p.before_update),p.fragment=!!u&&u(p.ctx),h.target){if(h.hydrate){const t=function(t){return Array.from(t.childNodes)}(h.target);p.fragment&&p.fragment.l(t),t.forEach(a)}else p.fragment&&p.fragment.c();h.intro&&L(t.$$.fragment),function(t,i,s){const{fragment:h,on_mount:o,on_destroy:u,after_update:a}=t.$$;h&&h.m(i,s),E(()=>{const i=o.map(n).filter(e);u?u.push(...i):r(i),t.$$.on_mount=[]}),a.forEach(E)}(t,h.target,h.anchor),C()}b(v)}function R(t){let n,s,h,c,p,y,m;return{c(){n=f("div"),s=f("div"),h=f("div"),c=l(),p=f("div"),this.c=i,d(h,"class","PlayerSlider__level"),w(h,"width",100*t[0]+"%"),d(p,"class","PlayerSlider__handle"),w(p,"left",100*t[0]+"%"),d(s,"class","PlayerSlider__track"),d(n,"class","PlayerSlider")},m(i,r){u(i,n,r),o(n,s),o(s,h),o(s,c),o(s,p),t[6](s),y||(m=[v(window,"mousemove",(function(){e(t[2]?t[5]:null)&&(t[2]?t[5]:null).apply(this,arguments)})),v(window,"mouseup",(function(){e(t[2]?t[4]:null)&&(t[2]?t[4]:null).apply(this,arguments)})),v(n,"mousedown",t[3])],y=!0)},p(i,[n]){t=i,1&n&&w(h,"width",100*t[0]+"%"),1&n&&w(p,"left",100*t[0]+"%")},i:i,o:i,d(i){i&&a(n),t[6](null),y=!1,r(m)}}}function G(t,i,n){let s,{value:r=0}=i,e=!1;const h=(o=g(),u=_(),function(t,i){u(t,i),o.dispatchEvent&&o.dispatchEvent(new CustomEvent(t,{detail:i}))});var o,u;function a(t){const i=s.getBoundingClientRect(),n=i.height/2,e=i.width-2*n,o=t.pageX-i.left-n,u=Math.max(0,Math.min(1,o/e));r!==u&&h("change",{value:u})}return t.$set=t=>{"value"in t&&n(0,r=t.value)},[r,s,e,function(t){n(2,e=!0),a(t),h("inputstart")},function(t){n(2,e=!1),a(t),h("inputend")},a,function(t){x[t?"unshift":"push"](()=>{s=t,n(1,s)})}]}"function"==typeof HTMLElement&&(O=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){for(const t in this.$$.slotted)this.appendChild(this.$$.slotted[t])}attributeChangedCallback(t,i,n){this[t]=n}$destroy(){!function(t,i){const n=t.$$;null!==n.fragment&&(r(n.on_destroy),n.fragment&&n.fragment.d(i),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=i}$on(t,i){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(i),()=>{const t=n.indexOf(i);-1!==t&&n.splice(t,1)}}$set(){}});customElements.define("flipnote-player-slider-bar",class extends O{constructor(t){super(),this.shadowRoot.innerHTML="<style>.PlayerSlider{padding:6px 0}.PlayerSlider__track{cursor:pointer;position:relative;flex:1;height:4px;border-radius:3px;margin:6px 0;background:var(--flipnote-player-slider-track, #FFD3A6)}.PlayerSlider__level{position:absolute;width:100%;height:6px;margin:-1px;border-radius:8px;background:var(--flipnote-player-slider-level, #F36A2D)}.PlayerSlider__handle{position:absolute;top:0;height:10px;width:4px;margin-left:-2px;margin-top:-3px;border-radius:2px;background:var(--flipnote-player-slider-handle, #F36A2D)}</style>",z(this,{target:this.shadowRoot},G,R,h,{value:0}),t&&(t.target&&u(t.target,this,t.anchor),t.props&&(this.$set(t.props),C()))}static get observedAttributes(){return["value"]}get value(){return this.$$.ctx[0]}set value(t){this.$set({value:t}),C()}});var T=function(t,i){return(T=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])})(t,i)};function H(t,i){function n(){this.constructor=t}T(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}function K(t,i,n,s){return new(n||(n=Promise))((function(r,e){function h(t){try{u(s.next(t))}catch(t){e(t)}}function o(t){try{u(s.throw(t))}catch(t){e(t)}}function u(t){var i;t.done?r(t.value):(i=t.value,i instanceof n?i:new n((function(t){t(i)}))).then(h,o)}u((s=s.apply(t,i||[])).next())}))}function N(t,i){var n,s,r,e,h={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return e={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function o(e){return function(o){return function(e){if(n)throw new TypeError("Generator is already executing.");for(;h;)try{if(n=1,s&&(r=2&e[0]?s.return:e[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,e[1])).done)return r;switch(s=0,r&&(e=[2&e[0],r.value]),e[0]){case 0:case 1:r=e;break;case 4:return h.label++,{value:e[1],done:!1};case 5:h.label++,s=e[1],e=[0];continue;case 7:e=h.ops.pop(),h.trys.pop();continue;default:if(!(r=h.trys,(r=r.length>0&&r[r.length-1])||6!==e[0]&&2!==e[0])){h=0;continue}if(3===e[0]&&(!r||e[1]>r[0]&&e[1]<r[3])){h.label=e[1];break}if(6===e[0]&&h.label<r[1]){h.label=r[1],r=e;break}if(r&&h.label<r[2]){h.label=r[2],h.ops.push(e);break}r[2]&&h.ops.pop(),h.trys.pop();continue}e=i.call(t,h)}catch(t){e=[6,t],s=0}finally{n=r=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,o])}}}var q=[{matches:function(t){return"string"==typeof t},load:function(t,i,n){var s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onreadystatechange=function(t){4===s.readyState&&(s.status>=200&&s.status<300?i(s.response):n({type:"httpError",status:s.status,statusText:s.statusText}))},s.send(null)}},{matches:function(t){return"undefined"!=typeof File&&t instanceof File},load:function(t,i,n){if("undefined"!=typeof FileReader){var s=new FileReader;s.onload=function(t){i(s.result)},s.onerror=function(t){n({type:"fileReadError"})},s.readAsArrayBuffer(t)}else n()}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,i,n){i(t)}}];var Y,$=function(){function t(){this.page=-1,this.pages=[],this.cursor=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(t.pageSize),this.cursor=0},t.prototype.getData=function(){var i=this,n=new Uint8Array(this.page*t.pageSize+this.cursor);return this.pages.map((function(s,r){r===i.page?n.set(s.slice(0,i.cursor),r*t.pageSize):n.set(s,r*t.pageSize)})),n},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(i){this.cursor>=t.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=i},t.prototype.writeBytes=function(t,i,n){for(var s=n||t.length,r=i||0;r<s;r++)this.writeByte(t[r])},t.pageSize=4096,t}(),V=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.cursor=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,i){switch(i){case 2:this.cursor=this.data.byteLength+t;break;case 1:this.cursor+=t;break;case 0:default:this.cursor=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.cursor);return this.cursor+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.cursor,t),this.cursor+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.cursor);return this.cursor+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.cursor,t),this.cursor+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var i=this.data.getUint16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeUint16=function(t,i){void 0===i&&(i=!0),this.data.setUint16(this.cursor,t,i),this.cursor+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var i=this.data.getInt16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeInt16=function(t,i){void 0===i&&(i=!0),this.data.setInt16(this.cursor,t,i),this.cursor+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var i=this.data.getUint32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeUint32=function(t,i){void 0===i&&(i=!0),this.data.setUint32(this.cursor,t,i),this.cursor+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var i=this.data.getInt32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeInt32=function(t,i){void 0===i&&(i=!0),this.data.setInt32(this.cursor,t,i),this.cursor+=4},t.prototype.readBytes=function(t){var i=new Uint8Array(this.data.buffer,this.cursor,t);return this.cursor+=i.byteLength,i},t.prototype.writeBytes=function(t){var i=this;t.forEach((function(t){return i.writeUint8(t)}))},t.prototype.readHex=function(t,i){void 0===i&&(i=!1);for(var n=this.readBytes(t),s=[],r=0;r<n.length;r++)s.push(n[r].toString(16).padStart(2,"0"));return i&&s.reverse(),s.join("").toUpperCase()},t.prototype.readUtf8=function(t){for(var i=this.readBytes(t),n="",s=0;s<i.length;s++){var r=i[s];if(0===r)break;n+=String.fromCharCode(r)}return n},t.prototype.writeUtf8=function(t){for(var i=0;i<t.length;i++){var n=t.charCodeAt(i);this.writeUint8(n)}},t.prototype.readUtf16=function(t){for(var i=new Uint16Array(this.data.buffer,this.cursor,t),n="",s=0;s<i.length;s++){var r=i[s];if(0==r)break;n+=String.fromCharCode(r)}return this.cursor+=i.byteLength,n},t}();!function(t){t[t.BGM=0]="BGM",t[t.SE1=1]="SE1",t[t.SE2=2]="SE2",t[t.SE3=3]="SE3",t[t.SE4=4]="SE4"}(Y||(Y={}));for(var Z=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return H(i,t),i.prototype.hasAudioTrack=function(t){return!!(this.soundMeta.hasOwnProperty(t)&&this.soundMeta[t].length>0)},i.prototype.getInt16AudioData=function(t){return this.decodeAudio(t)},i.prototype.getFloat32AudioData=function(t){for(var i=this.decodeAudio(t),n=new Float32Array(i.length),s=0;s<i.length;s++)n[s]=i[s]/32767;return n},i}(V),X=new Int8Array([-1,2,-1,2]),J=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),Q=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),tt=new Int16Array(360),it=0;it<4;it++)for(var nt=0;nt<90;nt++){var st=(et=Q[nt])>>3;1&it&&(st+=et),2&it&&(st=-st),tt[it+4*nt]=st}var rt=new Int16Array(1440);for(it=0;it<16;it++)for(nt=0;nt<90;nt++){var et;st=(et=Q[nt])>>3;4&it&&(st+=et),2&it&&(st+=et>>1),1&it&&(st+=et>>2),8&it&&(st=-st),rt[it+16*nt]=st}for(var ht=[null,.5,1,2,4,6,12,20,30],ot={WHITE:[255,255,255],BLACK:[14,14,14],RED:[255,42,42],BLUE:[10,57,255]},ut=function(t){function i(n){var s=t.call(this,n)||this;return s.type=i.type,s.width=i.width,s.height=i.height,s.globalPalette=i.globalPalette,s.sampleRate=i.sampleRate,s.prevDecodedFrame=null,s.decodeHeader(),s.decodeAnimationHeader(),s.decodeSoundHeader(),s.decodeMeta(),s.layers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],s.prevLayers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],s.prevDecodedFrame=null,s}return H(i,t),i.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},i.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},i.prototype.readFilename=function(){return[this.readHex(3),this.readUtf8(13),this.readUint16().toString().padStart(3,"0")].join("_")},i.prototype.readLineEncoding=function(){for(var t=new Uint8Array(i.height),n=0;n<48;n++)for(var s=this.readUint8(),r=0;r<8;r+=2)t[4*n+r/2]=s>>r&3;return t},i.prototype.decodeHeader=function(){this.seek(0);this.readUint32();this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},i.prototype.decodeMeta=function(){this.seek(16);var t=this.readUint16(),i=this.readInt16(),n=this.readUtf16(11),s=this.readUtf16(11),r=this.readUtf16(11),e=this.readHex(8,!0),h=this.readHex(8,!0),o=this.readFilename(),u=this.readFilename(),a=this.readHex(8,!0);this.seek(154);var f=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=i,this.meta={lock:1===t,loop:1==(c>>1&1),frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:i,timestamp:f,spinoff:h!==e||h!==a,root:{filename:null,username:n,fsid:a},parent:{username:s,fsid:e,filename:o},current:{username:r,fsid:h,filename:u}}},i.prototype.decodeAnimationHeader=function(){var t=this;this.seek(1696);var i=this.readUint16();this.seek(1704),this.frameOffsets=new Uint32Array(i/4).map((function(n){return 1704+i+t.readUint32()}))},i.prototype.decodeSoundHeader=function(){var t,i=1696+this.frameDataLength+this.frameCount;i%4!=0&&(i+=4-i%4),this.seek(i);var n=this.readUint32(),s=this.readUint32(),r=this.readUint32(),e=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),i+=32,this.framerate=ht[this.frameSpeed],this.bgmrate=ht[this.bgmSpeed],this.soundMeta=((t={})[Y.BGM]={offset:i,length:n},t[Y.SE1]={offset:i+=n,length:s},t[Y.SE2]={offset:i+=s,length:r},t[Y.SE3]={offset:i+=r,length:e},t)},i.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},i.prototype.getLayerOrder=function(t){return[0,1]},i.prototype.decodeFrame=function(t){0===t||this.prevDecodedFrame===t-1||this.isNewFrame(t)||this.decodeFrame(t-1),this.seek(this.frameOffsets[t]);var n=this.readUint8(),s=n>>7&1,r=n>>5&3,e=0,h=0;this.prevLayers[0].set(this.layers[0]),this.prevLayers[1].set(this.layers[1]),this.prevDecodedFrame=t,this.layers[0].fill(0),this.layers[1].fill(0),r&&(e=this.readInt8(),h=this.readInt8());for(var o=[this.readLineEncoding(),this.readLineEncoding()],u=0;u<2;u++)for(var a=this.layers[u],f=0;f<i.height;f++){var c=o[u][f],l=f*i.width;switch(c){case 0:break;case 1:case 2:var v=this.readUint32(!1);for(2==c&&a.fill(255,l,l+i.width);4294967295&v;){if(2147483648&v)for(var d=this.readUint8(),p=0;p<8;p++)a[l+p]=d>>p&1?255:0;l+=8,v<<=1}break;case 3:for(;l<(f+1)*i.width;){for(d=this.readUint8(),p=0;p<8;p++)a[l+p]=d>>p&1?255:0;l+=8}}}if(!s)for(var y=void 0,w=void 0,m=0;m<i.height;m++)if(!(m-h<0)){if(m-h>=i.height)break;for(var b=0;b<i.width;b++)if(!(b-e<0)){if(b-e>=i.width)break;w=(y=b+m*i.width)-(e+h*i.width),this.layers[0][y]^=this.prevLayers[0][w],this.layers[1][y]^=this.prevLayers[1][w]}}return this.layers},i.prototype.getFramePaletteIndices=function(t){this.seek(this.frameOffsets[t]);var i=this.readUint8(),n=1!=(1&i),s=[n?0:1,n?0:1,2,3];return[n?1:0,s[i>>1&3],s[i>>3&3]]},i.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,n){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var s=this.getFramePaletteIndices(t),r=this.layers[n],e=new Uint8Array(i.width*i.height),h=s[n+1],o=0;o<e.length;o++)0!==r[o]&&(e[o]=h);return e},i.prototype.getFramePixels=function(t){var n=this.getFramePaletteIndices(t),s=this.decodeFrame(t),r=new Uint8Array(i.width*i.height);r.fill(n[0]);for(var e=0;e<r.length;e++){var h=s[0][e],o=s[1][e];0!==h?r[e]=n[1]:0!==o&&(r[e]=n[2])}return r},i.prototype.decodeAudio=function(t){for(var i,n,s,r=this.soundMeta[t],e=new Uint8Array(this.buffer,r.offset,r.length),h=new Int16Array(2*e.length),o=0,u=0,a=0,f=0;f<e.length;f++)for(var c=e[f],l=0;l<8;)n=u+rt[(i=c>>l&15)+16*a],s=a+J[i],s=Math.max(0,Math.min(s,79)),n=Math.max(-32767,Math.min(n,32767)),h[o]=n,o+=1,a=s,u=n,l+=4;return h},i.prototype.decodeSoundFlags=function(){var t=this;return this.seek(1696+this.frameDataLength),new Array(this.frameCount).fill([]).map((function(i){var n=t.readUint8();return[1&n,n>>1&1,n>>2&1]}))},i.type="PPM",i.width=256,i.height=192,i.sampleRate=8192,i.globalPalette=[ot.WHITE,ot.BLACK,ot.RED,ot.BLUE],i}(Z),at=new Uint16Array(52488),ft=[0,65280,255],ct=0,lt=0;lt<3;lt++)for(var vt=0;vt<3;vt++)for(var dt=0;dt<3;dt++)for(var pt=0;pt<3;pt++)for(var yt=0;yt<3;yt++)for(var wt=0;wt<3;wt++)for(var mt=0;mt<3;mt++)for(var bt=0;bt<3;bt++)at.set([ft[vt],ft[lt],ft[pt],ft[dt],ft[wt],ft[yt],ft[bt],ft[mt]],ct),ct+=8;var gt=new Uint16Array(52488);for(ct=0,lt=0;lt<2187;lt+=729)for(vt=0;vt<729;vt+=243)for(dt=0;dt<243;dt+=81)for(pt=0;pt<81;pt+=27)for(yt=0;yt<27;yt+=9)for(wt=0;wt<9;wt+=3)for(mt=0;mt<3;mt+=1)for(bt=0;bt<6561;bt+=2187){var _t=lt+vt+dt+pt+yt+wt+mt+bt,At=at.subarray(8*_t,8*_t+8);gt.set(At,ct),ct+=8}var xt=new Uint16Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,i){var n=at.subarray(8*t,8*t+8);xt.set(n,8*i)}));var Ut=new Uint16Array(256);[0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100].forEach((function(t,i){var n=at.subarray(8*t,8*t+8);Ut.set(n,8*i)}));var kt=[.2,.5,1,2,4,6,8,12,20,24,30],Pt={WHITE:[255,255,255],BLACK:[16,16,16],RED:[255,16,16],YELLOW:[255,231,0],GREEN:[0,134,49],BLUE:[0,56,206],NONE:[255,255,255]},St=function(t){function i(n){var s=t.call(this,n)||this;return s.type=i.type,s.width=i.width,s.height=i.height,s.globalPalette=i.globalPalette,s.sampleRate=i.sampleRate,s.prevDecodedFrame=null,s.bitIndex=0,s.bitValue=0,s.layers=[new Uint16Array(i.width*i.height),new Uint16Array(i.width*i.height),new Uint16Array(i.width*i.height)],s.bitIndex=0,s.bitValue=0,s.load(),s}return H(i,t),i.prototype.load=function(){this.seek(0),this.sections={},this.frameMeta=[];for(var t=this.byteLength-256,i=0,n=0;i<t&&n<6;){this.seek(i);var s=this.readUtf8(4).substring(0,3),r=this.readUint32();this.sections[s]={offset:i,length:r},i+=r+8,n+=1}this.decodeMeta(),this.decodeFrameMeta(),this.decodeSoundHeader()},i.prototype.readBits=function(t){if(this.bitIndex+t>16){var i=this.readUint16();this.bitValue|=i<<16-this.bitIndex,this.bitIndex-=16}var n=(1<<t)-1,s=this.bitValue&n;return this.bitValue>>=t,this.bitIndex+=t,s},i.prototype.decodeMeta=function(){this.seek(this.sections.KFH.offset+12);var t=new Date(1e3*(this.readUint32()+946684800)),i=new Date(1e3*(this.readUint32()+946684800)),n=(this.readUint32(),this.readHex(10)),s=this.readHex(10),r=this.readHex(10),e=this.readUtf16(11),h=this.readUtf16(11),o=this.readUtf16(11),u=this.readUtf8(28),a=this.readUtf8(28),f=this.readUtf8(28),c=this.readUint16(),l=this.readUint16(),v=this.readUint16(),d=this.readUint8();this.readUint8();this.frameCount=c,this.thumbFrameIndex=l,this.frameSpeed=d,this.framerate=kt[d],this.meta={lock:1==(1&v),loop:1==(v>>1&1),frame_count:c,frame_speed:d,thumb_index:l,timestamp:i,creation_timestamp:t,root:{username:e,fsid:n,filename:u},parent:{username:h,fsid:s,filename:a},current:{username:o,fsid:r,filename:f}}},i.prototype.decodeFrameMeta=function(){this.frameOffsets=new Uint32Array(this.frameCount),this.seek(this.sections.KMI.offset+8);for(var t=this.sections.KMC.offset+12,i=0;i<this.frameCount;i++){var n={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readHex(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(n),this.frameOffsets[i]=t,t+=n.layerSize[0]+n.layerSize[1]+n.layerSize[2]}},i.prototype.decodeSoundHeader=function(){var t;if(this.sections.hasOwnProperty("KSN")){var i=this.sections.KSN.offset+8;this.seek(i);var n=this.readUint32();this.bgmSpeed=n,this.bgmrate=kt[n];var s=new Uint32Array(this.buffer,i+4,20);this.soundMeta=((t={})[Y.BGM]={offset:i+=28,length:s[0]},t[Y.SE1]={offset:i+=s[0],length:s[1]},t[Y.SE2]={offset:i+=s[1],length:s[2]},t[Y.SE3]={offset:i+=s[2],length:s[3]},t[Y.SE4]={offset:i+=s[3],length:s[4]},t)}},i.prototype.getDiffingFlag=function(t){return 7&~(this.frameMeta[t].flags>>4)},i.prototype.getLayerDepths=function(t){return this.frameMeta[t].layerDepth},i.prototype.getLayerOrder=function(t){var i=this.getLayerDepths(t);return[2,1,0].sort((function(t,n){return i[n]-i[t]}))},i.prototype.decodeFrame=function(t,n,s){void 0===n&&(n=7),void 0===s&&(s=!1),s&&(n&=this.getDiffingFlag(t+1)),0!==t&&this.prevDecodedFrame!==t-1&&n&&this.decodeFrame(t-1,n=n,s=!0);for(var r=this.frameMeta[t],e=this.frameOffsets[t],h=0;h<3;h++){this.seek(e);var o=r.layerSize[h];if(e+=o,38!==o&&0!=(n>>h&1)){this.bitIndex=16,this.bitValue=0;for(var u=0,a=0;a<i.height;a+=128)for(var f=0;f<i.width;f+=128)for(var c=0;c<128;c+=8){var l=a+c;if(l>=i.height)break;for(var v=0;v<128;v+=8){var d=f+v;if(d>=i.width)break;if(u)u-=1;else{var p=l*i.width+d,y=this.layers[h],w=this.readBits(3);if(0==w){var m=this.readBits(5),b=xt.subarray(8*m,8*m+8);y.set(b,p),y.set(b,p+320),y.set(b,p+640),y.set(b,p+960),y.set(b,p+1280),y.set(b,p+1600),y.set(b,p+1920),y.set(b,p+2240)}else if(1==w){m=this.readBits(13),b=at.subarray(8*m,8*m+8);y.set(b,p),y.set(b,p+320),y.set(b,p+640),y.set(b,p+960),y.set(b,p+1280),y.set(b,p+1600),y.set(b,p+1920),y.set(b,p+2240)}else if(2==w){var g=this.readBits(5),_=xt.subarray(8*g,8*g+8),A=Ut.subarray(8*g,8*g+8);y.set(_,p),y.set(A,p+320),y.set(_,p+640),y.set(A,p+960),y.set(_,p+1280),y.set(A,p+1600),y.set(_,p+1920),y.set(A,p+2240)}else if(3==w){g=this.readBits(13),_=at.subarray(8*g,8*g+8),A=gt.subarray(8*g,8*g+8);y.set(_,p),y.set(A,p+320),y.set(_,p+640),y.set(A,p+960),y.set(_,p+1280),y.set(A,p+1600),y.set(_,p+1920),y.set(A,p+2240)}else if(4==w)for(var x=this.readBits(8),U=0;U<8;U++)if(x&1<<U){m=this.readBits(5),b=xt.subarray(8*m,8*m+8);y.set(b,p+320*U)}else{m=this.readBits(13),b=at.subarray(8*m,8*m+8);y.set(b,p+320*U)}else{if(5==w){u=this.readBits(5);continue}if(7==w){var k=this.readBits(2);_=void 0,A=void 0;if(this.readBits(1)){var P=this.readBits(5),S=this.readBits(5);_=xt.subarray(8*P,8*P+8),A=xt.subarray(8*S,8*S+8),k=(k+1)%4}else{P=this.readBits(13),S=this.readBits(13);_=at.subarray(8*P,8*P+8),A=at.subarray(8*S,8*S+8)}0==k?(y.set(_,p),y.set(A,p+320),y.set(_,p+640),y.set(A,p+960),y.set(_,p+1280),y.set(A,p+1600),y.set(_,p+1920),y.set(A,p+2240)):1==k?(y.set(_,p),y.set(_,p+320),y.set(A,p+640),y.set(_,p+960),y.set(_,p+1280),y.set(A,p+1600),y.set(_,p+1920),y.set(_,p+2240)):2==k?(y.set(_,p),y.set(A,p+320),y.set(_,p+640),y.set(_,p+960),y.set(A,p+1280),y.set(_,p+1600),y.set(_,p+1920),y.set(A,p+2240)):3==k&&(y.set(_,p),y.set(A,p+320),y.set(A,p+640),y.set(_,p+960),y.set(A,p+1280),y.set(A,p+1600),y.set(_,p+1920),y.set(A,p+2240))}}}}}}}return this.prevDecodedFrame=t,[new Uint8Array(this.layers[0].buffer),new Uint8Array(this.layers[1].buffer),new Uint8Array(this.layers[2].buffer)]},i.prototype.getFramePaletteIndices=function(t){var i=this.frameMeta[t].flags;return[15&i,i>>8&15,i>>12&15,i>>16&15,i>>20&15,i>>24&15,i>>28&15]},i.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,n){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var s=this.getFramePaletteIndices(t),r=this.layers[n],e=new Uint8Array(i.width*i.height),h=2*n+1,o=0;o<r.length;o++){var u=r[o];65280&u?e[o]=s[h]:255&u&&(e[o]=s[h+1])}return e},i.prototype.getFramePixels=function(t){var n=this,s=this.getFramePaletteIndices(t),r=new Uint8Array(i.width*i.height);return r.fill(s[0]),this.getLayerOrder(t).forEach((function(i){for(var s=n.getLayerPixels(t,i),e=0;e<s.length;e++){var h=s[e];0!==h&&(r[e]=h)}})),r},i.prototype.decodeSoundFlags=function(){return this.frameMeta.map((function(t){var i=t.soundFlags;return[1&i,i>>1&1,i>>2&1,i>>3&1]}))},i.prototype.decodeAudio=function(t){for(var i,n,s,r=this.soundMeta[t],e=new Uint8Array(this.buffer,r.offset,r.length),h=new Int16Array(981840),o=0,u=0,a=40,f=0;f<e.length;f++)for(var c=e[f],l=0;l<8;)a<18||6==l?(n=u+tt[(i=c>>l&3)+4*a],s=a+X[i],l+=2):(n=u+rt[(i=c>>l&15)+16*a],s=a+J[i],l+=4),s=Math.max(0,Math.min(s,79)),n=Math.max(-2047,Math.min(n,2047)),h[o]=16*n,o+=1,a=s,u=n;return h.slice(0,o)},i.type="KWZ",i.width=320,i.height=240,i.sampleRate=16364,i.globalPalette=[Pt.WHITE,Pt.BLACK,Pt.RED,Pt.YELLOW,Pt.GREEN,Pt.BLUE,Pt.NONE],i}(Z);function Et(t){return function(t){return new Promise((function(i,n){q.forEach((function(s){s.matches(t)&&s.load(t,i,n)}))}))}(t).then((function(t){return new Promise((function(i,n){var s=new Uint8Array(t.slice(0,4)),r=s[0]<<24|s[1]<<16|s[2]<<8|s[3];1346458177===r?i(new ut(t)):1262897152==(4294967040&r)?i(new St(t)):n()}))}))}var Ft,Mt=function(){function t(t,i,n){void 0===i&&(i=1),void 0===n&&(n=16),this.sampleRate=t,this.channels=i,this.bitsPerSample=n;var s=new ArrayBuffer(44),r=new V(s);r.writeUtf8("RIFF"),r.writeUint32(0),r.writeUtf8("WAVE"),r.writeUtf8("fmt "),r.writeUint32(16),r.writeUint16(1),r.writeUint16(this.channels),r.writeUint32(this.sampleRate),r.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample),r.writeUtf8("data"),r.writeUint32(0),this.header=r,this.pcmData=null}return t.prototype.writeFrames=function(t){var i=this.header;i.seek(4),i.writeUint32(i.byteLength+t.byteLength),i.seek(40),i.writeUint32(t.byteLength),this.pcmData=t},t.prototype.getBlob=function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})},t}(),Ct=function(){function t(t){this.playbackRate=1,this.id=t,this.channelCount=1,this.bitsPerSample=16,this.sampleRate=0,this.audio=document.createElement("audio"),this.audio.preload="auto",this.isActive=!1}return t.prototype.set=function(t,i){var n=new Mt(this.sampleRate*i,this.channelCount,this.bitsPerSample);n.writeFrames(t),this.url=window.URL.createObjectURL(n.getBlob()),this.audio.src=this.url,this.isActive=!0,this.playbackRate=i,this.length=t.length},Object.defineProperty(t.prototype,"duration",{get:function(){return this.audio.duration},enumerable:!1,configurable:!0}),t.prototype.unset=function(){this.isActive&&(window.URL.revokeObjectURL(this.url),this.audio.src="",this.audio.load(),this.isActive=!1,this.playbackRate=1,this.length=null)},t.prototype.start=function(t){void 0===t&&(t=0),this.isActive&&(this.audio.currentTime=t,this.audio.play())},t.prototype.stop=function(){this.isActive&&this.audio.pause()},t}();!function(t){t[t.Alpha=WebGLRenderingContext.ALPHA]="Alpha",t[t.LuminanceAlpha=WebGLRenderingContext.LUMINANCE_ALPHA]="LuminanceAlpha"}(Ft||(Ft={}));var jt=function(){function t(t,i,n,s){void 0===i&&(i=640),void 0===n&&(n=480),void 0===s&&(s={antialias:!1,alpha:!1}),this.uniforms={},this.refs={shaders:[],textures:[],buffers:[]};var r=t.getContext("webgl",s);this.el=t,this.gl=r,this.width=t.width=i,this.height=t.height=n,this.createProgram(),this.createScreenQuad(),this.createBitmapTexture(),this.setCanvasSize(this.width,this.height),r.enable(r.BLEND),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)}return t.prototype.createProgram=function(){var t=this.gl,i=t.createProgram();if(t.attachShader(i,this.createShader(t.VERTEX_SHADER,"#define GLSLIFY 1\nattribute vec4 a_position;varying vec2 v_texel;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){gl_Position=a_position;vec2 uv=a_position.xy*vec2(0.5,-0.5)+0.5;v_texel=uv*u_textureSize;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);}")),t.attachShader(i,this.createShader(t.FRAGMENT_SHADER,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_texel;varying float v_scale;uniform vec4 u_color1;uniform vec4 u_color2;uniform sampler2D u_bitmap;uniform bool u_isSmooth;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;vec2 colorWeights=texture2D(u_bitmap,coord).ra;gl_FragColor=vec4(u_color1.rgb,1.0)*colorWeights.y+vec4(u_color2.rgb,1.0)*colorWeights.x;}")),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){var n=t.getProgramInfoLog(i);throw t.deleteProgram(i),new Error(n)}t.useProgram(i);for(var s=t.getProgramParameter(i,t.ACTIVE_UNIFORMS),r=0;r<s;r++){var e=t.getActiveUniform(i,r).name;this.uniforms[e]=t.getUniformLocation(i,e)}this.program=i},t.prototype.createScreenQuad=function(){var t=this.gl,i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0),this.refs.buffers.push(i)},t.prototype.createBitmapTexture=function(){var t=this.gl;t.activeTexture(t.TEXTURE0);var i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.uniform1i(this.uniforms.u_bitmap,0),this.refs.textures.push(i)},t.prototype.createShader=function(t,i){var n=this.gl,s=n.createShader(t);if(n.shaderSource(s,i),n.compileShader(s),!n.getShaderParameter(s,n.COMPILE_STATUS)){var r=n.getShaderInfoLog(s);throw n.deleteShader(s),new Error(r)}return this.refs.shaders.push(s),s},t.prototype.setInputSize=function(t,i){this.gl.uniform2f(this.uniforms.u_textureSize,t,i)},t.prototype.setCanvasSize=function(t,i){this.gl.uniform2f(this.uniforms.u_screenSize,t,i),this.el.width=t,this.el.height=i,this.width=t,this.height=i,this.gl.viewport(0,0,t,i)},t.prototype.setLayerType=function(t){this.textureType=t},t.prototype.toImage=function(t){return this.el.toDataURL(t)},t.prototype.setColor=function(t,i){this.gl.uniform4f(this.uniforms[t],i[0]/255,i[1]/255,i[2]/255,1)},t.prototype.setPaperColor=function(t){this.gl.clearColor(t[0]/255,t[1]/255,t[2]/255,1)},t.prototype.drawLayer=function(t,i,n,s,r){var e=this.gl;e.texImage2D(e.TEXTURE_2D,0,this.textureType,i,n,0,this.textureType,e.UNSIGNED_BYTE,t),this.setColor("u_color1",s),this.setColor("u_color2",r),e.drawArrays(e.TRIANGLES,0,6)},t.prototype.resize=function(t,i){void 0===t&&(t=640),void 0===i&&(i=480),this.setCanvasSize(t,i)},t.prototype.clear=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)},t.prototype.destroy=function(){var t=this.refs,i=this.gl;t.shaders.forEach((function(t){i.deleteShader(t)})),t.shaders=[],t.textures.forEach((function(t){i.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){i.deleteBuffer(t)})),t.buffers=[],i.deleteProgram(this.program),i.canvas.width=1,i.canvas.height=1},t}(),Bt=function(){function t(t,i,n){this.loop=!1,this.paused=!0,this.duration=0,this.isOpen=!1,this.events={},this.t=-1,this.s=0,this.hasPlaybackStarted=!1,this.wasPlaying=!1,this.isSeeking=!1,t="string"==typeof t?document.querySelector(t):t,this.canvas=new jt(t,i,n),this.el=this.canvas.el,this.customPalette=null,this.audioTracks=[new Ct("se1"),new Ct("se2"),new Ct("se3"),new Ct("se4"),new Ct("bgm")]}return Object.defineProperty(t.prototype,"currentFrame",{get:function(){return this.t},set:function(t){this.setFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return this.isOpen?this.s:null},set:function(t){this.isOpen&&t<=this.duration&&t>=0&&(this.setFrame(Math.round(t/(1/this.framerate))),this.s=t,this.emit("progress",this.progress))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"progress",{get:function(){return this.isOpen?this.currentTime/this.duration*100:0},set:function(t){this.currentTime=this.duration*(t/100)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this.audioTracks[3].audio.volume},set:function(t){for(var i=0;i<this.audioTracks.length;i++)this.audioTracks[i].audio.volume=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"muted",{get:function(){return this.audioTracks[3].audio.muted},set:function(t){for(var i=0;i<this.audioTracks.length;i++)this.audioTracks[i].audio.muted=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"audiorate",{get:function(){return 1/this.note.bgmrate/(1/this.note.framerate)},enumerable:!1,configurable:!0}),t.prototype.open=function(t){return K(this,void 0,void 0,(function(){var i=this;return N(this,(function(n){return this.isOpen&&this.close(),[2,Et(t).then((function(t){i.load(t)})).catch((function(t){throw i.emit("error",t),console.error("Error loading Flipnote:",t),"Error loading Flipnote"}))]}))}))},t.prototype.close=function(){this.pause(),this.note=null,this.isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.t=null,this.s=null,this.duration=null,this.loop=null;for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].unset();this.seFlags=null,this.hasPlaybackStarted=null,this.canvas.clear()},t.prototype.load=function(t){var i=this;this.note=t,this.meta=t.meta,this.type=t.type,this.loop=t.meta.loop,this.duration=this.note.frameCount*(1/this.note.framerate),this.paused=!0,this.isOpen=!0,this.audioTracks.forEach((function(i){i.sampleRate=t.sampleRate})),[Y.SE1,Y.SE2,Y.SE3,Y.SE4,Y.BGM].forEach((function(t,n){var s=t===Y.BGM?i.audiorate:1;i.note.hasAudioTrack(t)&&i.audioTracks[n].set(i.note.decodeAudio(t),s)})),this.seFlags=this.note.decodeSoundFlags(),this.hasPlaybackStarted=!1,this.layerVisibility={1:!0,2:!0,3:!0},this.canvas.setInputSize(t.width,t.height),this.canvas.setLayerType("PPM"===this.type?Ft.Alpha:Ft.LuminanceAlpha),this.setFrame(this.note.thumbFrameIndex),this.s=0,this.emit("load")},t.prototype.play=function(){var t=this;if(!this.isOpen||!this.paused)return null;this.hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.s=0),this.paused=!1,this.playBgm();var i=performance.now()/1e3-this.currentTime,n=function(s){if(t.paused)return t.stopAudio(),null;var r=s/1e3,e=r-i;e>t.duration?t.loop?(t.currentTime=0,t.playBgm(),i=r,t.emit("playback:loop")):(t.pause(),t.emit("playback:end")):t.currentTime=e,requestAnimationFrame(n)};requestAnimationFrame(n),this.hasPlaybackStarted=!0,this.emit("playback:start")},t.prototype.pause=function(){if(!this.isOpen||this.paused)return null;this.paused=!0,this.stopAudio(),this.emit("playback:stop")},t.prototype.setFrame=function(t){this.isOpen&&t!==this.currentFrame&&(t=Math.max(0,Math.min(Math.floor(t),this.frameCount-1)),this.drawFrame(t),this.t=t,this.paused?(this.s=t*(1/this.framerate),this.emit("progress",this.progress)):this.playFrameSe(t),this.emit("frame:update",this.currentFrame))},t.prototype.nextFrame=function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1},t.prototype.prevFrame=function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1},t.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1},t.prototype.firstFrame=function(){this.currentFrame=0},t.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},t.prototype.startSeek=function(){this.isSeeking||(this.wasPlaying=!this.paused,this.pause(),this.isSeeking=!0)},t.prototype.seek=function(t){this.isSeeking&&(this.progress=t)},t.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},t.prototype.drawFrame=function(t){var i=this,n=this.note.width,s=this.note.height,r=this.note.getFramePalette(t),e=this.note.decodeFrame(t);this.canvas.setPaperColor(r[0]),this.canvas.clear(),"PPM"===this.note.type?(this.layerVisibility[2]&&this.canvas.drawLayer(e[1],n,s,r[2],[0,0,0,0]),this.layerVisibility[1]&&this.canvas.drawLayer(e[0],n,s,r[1],[0,0,0,0])):"KWZ"===this.note.type&&this.note.getLayerOrder(t).forEach((function(t){i.layerVisibility[t+1]&&i.canvas.drawLayer(e[t],n,s,r[2*t+1],r[2*t+2])}))},t.prototype.forceUpdate=function(){this.isOpen&&this.drawFrame(this.currentFrame)},t.prototype.playFrameSe=function(t){for(var i=this.seFlags[t],n=0;n<i.length;n++)i[n]&&this.audioTracks[n].isActive&&this.audioTracks[n].start()},t.prototype.playBgm=function(){this.audioTracks[4].start(this.currentTime)},t.prototype.stopAudio=function(){for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].stop()},t.prototype.resize=function(t,i){this.canvas.resize(t,i),this.forceUpdate()},t.prototype.setLayerVisibility=function(t,i){this.layerVisibility[t]=i,this.forceUpdate()},t.prototype.on=function(t,i){var n=this.events;(n[t]||(n[t]=[])).push(i)},t.prototype.off=function(t,i){var n=this.events[t];n&&n.splice(n.indexOf(i),1)},t.prototype.emit=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];for(var s=this.events[t]||[],r=0;r<s.length;r++)s[r].apply(null,i)},t.prototype.clearEvents=function(){this.events={}},t.prototype.destroy=function(){this.close(),this.canvas.destroy()},t}();function It(t){let i,n,s,e,h,w,m,b,g=t[3]?"Pause":"Play";return{c(){i=f("div"),n=f("button"),s=c(g),e=l(),h=f("flipnote-player-slider-bar"),d(n,"class","Button PlayerControls__playButton"),p(h,"class","PlayerControls__progressBar"),p(h,"value",w=t[2]/100),d(i,"class","PlayerControls PlayerControls--compact")},m(r,a){u(r,i,a),o(i,n),o(n,s),o(i,e),o(i,h),m||(b=[v(n,"click",t[8]),v(h,"change",t[5]),v(h,"inputstart",t[6]),v(h,"inputend",t[7])],m=!0)},p(t,i){8&i&&g!==(g=t[3]?"Pause":"Play")&&y(s,g),4&i&&w!==(w=t[2]/100)&&p(h,"value",w)},d(t){t&&a(i),m=!1,r(b)}}}function Ot(t){let i,n,s,r=t[15]+"";return{c(){i=f("p"),n=c("error, oh no "),s=c(r),w(i,"color","red")},m(t,r){u(t,i,r),o(i,n),o(i,s)},p(t,i){16&i&&r!==(r=t[15]+"")&&y(s,r)},d(t){t&&a(i)}}}function Lt(t){let n;return{c(){n=f("p"),n.textContent="loaded"},m(t,i){u(t,n,i)},p:i,d(t){t&&a(n)}}}function Dt(t){let n;return{c(){n=f("p"),n.textContent="...loading"},m(t,i){u(t,n,i)},p:i,d(t){t&&a(n)}}}function Wt(t){let n,s,r,e,h,c,v=t[0]&&It(t),p={ctx:t,current:null,token:null,pending:Dt,then:Lt,catch:Ot,value:14,error:15};return D(c=t[4],p),{c(){n=f("div"),s=f("canvas"),r=l(),v&&v.c(),e=l(),h=f("div"),p.block.c(),this.c=i,d(s,"class","Player__canvas"),d(h,"class","p"),d(n,"class","Player"),w(n,"width","256px")},m(i,a){u(i,n,a),o(n,s),t[10](s),o(n,r),v&&v.m(n,null),o(n,e),o(n,h),p.block.m(h,p.anchor=null),p.mount=()=>h,p.anchor=null},p(i,[s]){if((t=i)[0]?v?v.p(t,s):(v=It(t),v.c(),v.m(n,e)):v&&(v.d(1),v=null),p.ctx=t,16&s&&c!==(c=t[4])&&D(c,p));else{const i=t.slice();i[14]=p.resolved,p.block.p(i,s)}},i:i,o:i,d(i){i&&a(n),t[10](null),v&&v.d(),p.block.d(),p.token=null,p=null}}}function zt(t,i,n){let s,r,{src:e=null}=i,{controls:h=!0}=i,o=0,u=!1,a=!1;var f;f=()=>{s=new Bt(r,512,384),s.on("progress",t=>{n(2,o=t)}),s.on("playback:start",()=>{n(3,u=!0)}),s.on("playback:stop",()=>{n(3,u=!1)})},g().$$.on_mount.push(f);let c=new Promise((t,i)=>i());return console.log(Bt),t.$set=t=>{"src"in t&&n(9,e=t.src),"controls"in t&&n(0,h=t.controls)},t.$$.update=()=>{512&t.$$.dirty&&e&&(console.log(e),n(4,c=async function(t){await s.open(t)}(e)))},[h,r,o,u,c,function(t){const{value:i}=t.detail;s.progress=100*i},function(t){u&&(s.pause(),a=!0)},function(t){a&&(s.play(),a=!1)},function(){u?s.pause():s.play()},e,function(t){x[t?"unshift":"push"](()=>{r=t,n(1,r)})}]}class Rt extends O{constructor(t){super(),this.shadowRoot.innerHTML="<style>.Button{border:0;outline:0;appearance:none;display:block;cursor:pointer;background:var(--flipnote-player-button-background, #FFD3A6);color:var(--flipnote-player-button-color, #F36A2D);border-radius:4px;height:32px;width:50px}.PlayerControls--compact{display:flex;align-items:center}.PlayerControls--compact .PlayerControls__playButton{margin-right:12px}.PlayerControls--compact .PlayerControls__progressBar{flex:1}</style>",z(this,{target:this.shadowRoot},zt,Wt,h,{src:9,controls:0}),t&&(t.target&&u(t.target,this,t.anchor),t.props&&(this.$set(t.props),C()))}static get observedAttributes(){return["src","controls"]}get src(){return this.$$.ctx[9]}set src(t){this.$set({src:t}),C()}get controls(){return this.$$.ctx[0]}set controls(t){this.$set({controls:t}),C()}}var Gt,Tt=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],Ht=function(){function t(t,i,n,s){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=i,this.pixels=n,this.colorDepth=s,this.initCodeSize=Math.max(2,this.colorDepth),this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.a_count,this.remaining,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}return t.prototype.char_out=function(t,i){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(i)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var i=0;i<t;++i)this.htab[i]=-1},t.prototype.compress=function(t,i){var n,s,r,e,h,o;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,e=this.nextPixel(),o=0,n=5003;n<65536;n*=2)++o;o=8-o,this.cl_hash(5003),this.output(this.ClearCode,i);t:for(;-1!=(s=this.nextPixel());)if(n=(s<<12)+e,r=s<<o^e,this.htab[r]!==n){if(this.htab[r]>=0){h=5003-r,0===r&&(h=1);do{if((r-=h)<0&&(r+=5003),this.htab[r]===n){e=this.codetab[r];continue t}}while(this.htab[r]>=0)}this.output(e,i),e=s,this.free_ent<4096?(this.codetab[r]=this.free_ent++,this.htab[r]=n):this.cl_block(i)}else e=this.codetab[r];this.output(e,i),this.output(this.EOFCode,i)},t.prototype.encode=function(t){t.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,t),t.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,i){for(this.cur_accum&=Tt[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(i)}},t}(),Kt=function(){function t(t,i){this.delay=100,this.repeat=-1,this.colorDepth=8,this.palette=[],this.width=t,this.height=i,this.data=new $}return t.fromFlipnote=function(i){var n=new t(i.width,i.height);n.palette=i.globalPalette,n.delay=100/i.framerate,n.repeat=i.meta.loop?-1:0,n.init();for(var s=0;s<i.frameCount;s++)n.writeFrame(i.getFramePixels(s));return n},t.fromFlipnoteFrame=function(i,n){var s=new t(i.width,i.height);return s.palette=i.globalPalette,s.delay=100/i.framerate,s.repeat=i.meta.loop?-1:0,s.init(),s.writeFrame(i.getFramePixels(n)),s},t.prototype.init=function(){for(var t=this.palette.length,i=1;1<<i<t;i+=1);this.colorDepth=i,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt()},t.prototype.writeHeader=function(){var t=new V(new ArrayBuffer(13));t.writeUtf8("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.colorDepth-1),t.writeUint8(0),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.colorDepth)),i=0,n=0;i<this.palette.length;i+=1,n+=3)t.set(this.palette[i],n);this.data.writeBytes(t)},t.prototype.writeGraphicsControlExt=function(){var t=new V(new ArrayBuffer(8));t.writeBytes([33,249,4,0]),t.writeUint16(this.delay),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeNetscapeExt=function(){var t=new V(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeUtf8("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeImageDesc=function(){var t=new V(new ArrayBuffer(10));t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writePixels=function(t){new Ht(this.width,this.height,t,this.colorDepth).encode(this.data)},t.prototype.writeFrame=function(t){this.writeGraphicsControlExt(),this.writeImageDesc(),this.writePixels(t)},t.prototype.getBuffer=function(){return this.data.getBuffer()},t.prototype.getBlob=function(){return new Blob([this.getBuffer()],{type:"image/gif"})},t.prototype.getUrl=function(){return window.URL.createObjectURL(this.getBlob())},t.prototype.getImage=function(){var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},t}();!function(t){t.version="4.0.3",t.player=Bt,t.parseSource=Et,t.kwzParser=St,t.ppmParser=ut,t.gifEncoder=Kt,t.wavEncoder=Mt}(Gt||(Gt={}));var Nt=Bt,qt=Et,Yt=St,$t=ut,Vt=Kt,Zt=Mt;customElements.define("flipnote-player",Rt);var Xt=Rt;t.gifEncoder=Vt,t.kwzParser=Yt,t.parseSource=qt,t.player=Nt,t.playerComponent=Xt,t.ppmParser=$t,t.version="4.0.3",t.wavEncoder=Zt,Object.defineProperty(t,"h",{value:!0})}));
